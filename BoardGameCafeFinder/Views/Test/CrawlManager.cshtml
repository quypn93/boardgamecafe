@{
    ViewData["Title"] = "Crawl Manager";
    Layout = "_AdminLayout";
}

<div class="mt-2">
    <div class="row mb-3">
        <div class="col-md-9">
            <h2>Board Game Cafe Crawler</h2>
            <p class="text-muted">Crawl board game cafes from Google Maps and save to database</p>
        </div>
        <div class="col-md-3 text-end">
            <button id="fixCoordinatesBtn" class="btn btn-info me-2" title="Fix cafe coordinates from Google Maps URLs">
                <i class="bi bi-geo-alt"></i> Fix Coords
            </button>
            <button id="cleanFalsePositiveGamesBtn" class="btn btn-outline-warning me-2" title="Remove false positive games like Sweet Spot, Wings, etc.">
                <i class="bi bi-x-circle"></i> Clean Games
            </button>
            <button id="cleanPhoneBtn" class="btn btn-warning me-2">
                <i class="bi bi-telephone"></i> Clean Phones
            </button>
            <button id="clearAllBtn" class="btn btn-danger">
                <i class="bi bi-trash"></i> Clear All
            </button>
        </div>
    </div>

    <!-- Crawl All Section -->
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Batch Crawl</h5>
            <small class="text-dark">With rate limiting to avoid blocking</small>
        </div>
        <div class="card-body">
            <div class="row align-items-center mb-3">
                <div class="col-md-2">
                    <label class="form-label">Delay (sec):</label>
                    <input type="number" id="crawlDelay" class="form-control" value="30" min="10" max="120">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Max per city:</label>
                    <input type="number" id="crawlMaxPerCity" class="form-control" value="15" min="5" max="30">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Max retries:</label>
                    <input type="number" id="crawlMaxRetries" class="form-control" value="2" min="0" max="5">
                </div>
                <div class="col-md-3">
                </div>
                <div class="col-md-3 text-end">
                    <label class="form-label d-block">&nbsp;</label>
                    <span class="badge bg-info" id="cityCount">~95 cities</span>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-md-4">
                    <button id="crawlAllUSBtn" class="btn btn-warning w-100">
                        <i class="bi bi-collection"></i> Crawl All US Cities
                    </button>
                </div>
                <div class="col-md-4">
                    <button id="retryFailedBtn" class="btn btn-outline-warning w-100" style="display:none;">
                        <i class="bi bi-arrow-repeat"></i> Retry Failed Cities (<span id="failedCount">0</span>)
                    </button>
                </div>
                <div class="col-md-4">
                    <button id="stopCrawlBtn" class="btn btn-danger w-100" style="display:none;">
                        <i class="bi bi-stop-circle"></i> Stop Crawling
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="batchProgress" class="mt-4" style="display:none;">
                <div class="progress mb-2" style="height: 25px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
                        0%
                    </div>
                </div>
                <div class="d-flex justify-content-between">
                    <small id="progressText">Preparing...</small>
                    <small id="progressEta">ETA: calculating...</small>
                </div>
                <div id="batchLog" class="mt-3 bg-dark text-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                </div>
            </div>
        </div>
    </div>

    <!-- BGG Sync Section -->
    <div class="card mb-4 border-info">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-controller"></i> BoardGameGeek Sync</h5>
            <small>Auto-discover BGG usernames and sync board games</small>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <button id="syncAllBggBtn" class="btn btn-info w-100">
                        <i class="bi bi-arrow-repeat"></i> Sync All Cafes (Auto-discover)
                    </button>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" id="testCafeName" class="form-control" placeholder="Enter cafe name to test...">
                        <button id="testBggUsernameBtn" class="btn btn-outline-info">
                            <i class="bi bi-search"></i> Find BGG Users
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" id="testBggUsername" class="form-control" placeholder="Enter BGG username...">
                        <button id="testBggCollectionBtn" class="btn btn-outline-info">
                            <i class="bi bi-list-ul"></i> View Collection
                        </button>
                    </div>
                </div>
            </div>

            <!-- BGG Progress Section -->
            <div id="bggProgress" class="mt-3" style="display:none;">
                <div class="progress mb-2" style="height: 25px;">
                    <div id="bggProgressBar" class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
                        0%
                    </div>
                </div>
                <small id="bggProgressText">Processing...</small>
            </div>

            <!-- BGG Results -->
            <div id="bggResults" class="mt-3" style="display:none;">
                <div class="alert alert-info">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> BGG Sync Results</h6>
                    <div id="bggResultsContent"></div>
                </div>
            </div>

            <!-- BGG Log -->
            <div id="bggLog" class="mt-3 bg-dark text-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; display:none;">
            </div>
        </div>
    </div>

    <!-- Board Games Whitelist Section -->
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-dice-5"></i> Board Games Whitelist</h5>
            <span class="badge bg-light text-dark" id="boardGamesCountBadge">Loading...</span>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">
                Board games in the whitelist are used for matching when crawling cafe websites.
                Games with BGG IDs are verified board games that will be matched during crawl.
            </p>
            <div class="row mb-3">
                <div class="col-md-2">
                    <div class="card bg-light">
                        <div class="card-body text-center py-2">
                            <h4 class="mb-0" id="totalGamesCount">-</h4>
                            <small class="text-muted">Total Games</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-light">
                        <div class="card-body text-center py-2">
                            <h4 class="mb-0" id="gamesWithBggCount">-</h4>
                            <small class="text-muted">With BGG ID</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card bg-light">
                        <div class="card-body text-center py-2">
                            <h4 class="mb-0" id="gamesWithCategoryCount">-</h4>
                            <small class="text-muted">With Category</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="number" id="seedCount" class="form-control" value="200" min="50" max="500" placeholder="Count">
                        <button id="seedBoardGamesBtn" class="btn btn-success">
                            <i class="bi bi-cloud-download"></i> Seed from BGG
                        </button>
                    </div>
                    <small class="text-muted">Import popular games from BoardGameGeek</small>
                </div>
                <div class="col-md-3">
                    <button id="updateCategoriesBtn" class="btn btn-info w-100 mb-1">
                        <i class="bi bi-tags"></i> Update Categories
                    </button>
                    <button id="refreshBoardGamesCountBtn" class="btn btn-outline-success w-100">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Count
                    </button>
                </div>
            </div>

            <!-- Seed Progress -->
            <div id="seedProgress" class="mt-3" style="display:none;">
                <div class="progress mb-2" style="height: 25px;">
                    <div id="seedProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
                        Seeding...
                    </div>
                </div>
                <small id="seedProgressText">Importing games from BGG...</small>
            </div>

            <!-- Seed Results -->
            <div id="seedResults" class="mt-3" style="display:none;"></div>
        </div>
    </div>

    <!-- Multi-Select Cities Section -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-check2-square"></i> Select Cities to Crawl</h5>
            <div>
                <button type="button" class="btn btn-sm btn-light" id="selectAllCitiesBtn">Select All</button>
                <button type="button" class="btn btn-sm btn-outline-light" id="deselectAllCitiesBtn">Deselect All</button>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Filter by Region</label>
                    <select id="regionFilter" class="form-select form-select-sm">
                        <option value="all">All Regions</option>
                        <option value="us">US Cities</option>
                        <option value="international">International</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Search Cities</label>
                    <input type="text" id="citySearchInput" class="form-control form-control-sm" placeholder="Type to filter...">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold d-block">&nbsp;</label>
                    <button id="crawlSelectedCitiesBtn" class="btn btn-success w-100" disabled>
                        <i class="bi bi-play-fill"></i> Crawl Selected (<span id="selectedCityCount">0</span>)
                    </button>
                </div>
            </div>

            <div class="border rounded p-3" style="max-height: 350px; overflow-y: auto;">
                <div class="mb-3">
                    <h6 class="text-primary"><i class="bi bi-geo-alt-fill"></i> US Cities</h6>
                    <div class="row" id="usCitiesCheckboxes">
                        <!-- US cities will be populated by JavaScript -->
                    </div>
                </div>
                <hr>
                <div>
                    <h6 class="text-success"><i class="bi bi-globe"></i> International Cities</h6>
                    <div class="row" id="intlCitiesCheckboxes">
                        <!-- International cities will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Crawl - Single City</h5>
            <div>
                <input type="text" id="quickCrawlSearch" class="form-control form-control-sm" placeholder="Search city..." style="width: 200px; display: inline-block;">
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">Click a city to crawl it immediately without selecting.</p>

            <h6 class="text-primary"><i class="bi bi-geo-alt-fill"></i> US Cities <span class="badge bg-primary" id="usQuickCount">0</span></h6>
            <div class="row mb-3" id="usQuickCrawlButtons" style="max-height: 300px; overflow-y: auto;">
                <!-- US cities buttons will be populated by JavaScript -->
            </div>

            <h6 class="text-success"><i class="bi bi-globe"></i> International Cities <span class="badge bg-success" id="intlQuickCount">0</span></h6>
            <div class="row" id="intlQuickCrawlButtons" style="max-height: 200px; overflow-y: auto;">
                <!-- International cities buttons will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Custom Location</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <input type="text" id="customLocation" class="form-control" placeholder="Enter city name...">
                </div>
                <div class="col-md-2">
                    <input type="number" id="customMaxResults" class="form-control" value="20" min="1" max="50">
                </div>
                <div class="col-md-2">
                    <button id="customCrawlBtn" class="btn btn-info w-100">
                        <i class="bi bi-search"></i> Crawl
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="results" class="card" style="display:none;">
        <div class="card-header">
            <h5 class="mb-0">Results</h5>
        </div>
        <div class="card-body">
            <div id="resultsContent"></div>
        </div>
    </div>

    <div id="loading" class="text-center" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Crawling <span id="currentLocation"></span>...</p>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function() {
        // Load board games count on page load
        loadBoardGamesCount();

        // Board Games Whitelist functions
        function loadBoardGamesCount() {
            $.get('/Test/BoardGamesCount', function(response) {
                $('#totalGamesCount').text(response.total);
                $('#gamesWithBggCount').text(response.withBggId);
                $('#gamesWithCategoryCount').text(response.withCategory);
                $('#boardGamesCountBadge').text(response.total + ' games');
            }).fail(function() {
                $('#totalGamesCount').text('Error');
                $('#gamesWithBggCount').text('Error');
                $('#gamesWithCategoryCount').text('Error');
                $('#boardGamesCountBadge').text('Error');
            });
        }

        $('#refreshBoardGamesCountBtn').on('click', function() {
            const $btn = $(this);
            $btn.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);
            loadBoardGamesCount();
            setTimeout(function() {
                $btn.html('<i class="bi bi-arrow-clockwise"></i> Refresh Count').prop('disabled', false);
            }, 500);
        });

        $('#updateCategoriesBtn').on('click', async function() {
            if (!confirm('This will update categories for all board games that have a BGG ID but no category.\n\nThis may take a while due to BGG API rate limiting.\n\nContinue?')) {
                return;
            }

            const $btn = $(this);
            $btn.html('<span class="spinner-border spinner-border-sm"></span> Updating...').prop('disabled', true);
            $('#seedProgress').show();
            $('#seedResults').hide();
            $('#seedProgressBar').css('width', '50%');
            $('#seedProgressText').text('Updating categories from BGG (this may take a while)...');

            try {
                const response = await $.ajax({
                    url: '/Test/UpdateBoardGameCategories',
                    type: 'POST',
                    timeout: 600000 // 10 minutes
                });

                $('#seedProgressBar').css('width', '100%').removeClass('progress-bar-animated');

                if (response.success) {
                    $('#seedResults').html(`
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle"></i> ${response.message}</h6>
                            <strong>Before:</strong> ${response.beforeCount} games with category<br>
                            <strong>Updated:</strong> ${response.updated} games<br>
                            <strong>Total Now:</strong> ${response.afterCount} games with category
                        </div>
                    `).show();
                    loadBoardGamesCount();
                } else {
                    $('#seedResults').html(`
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle"></i> Update Failed</h6>
                            ${response.message}
                        </div>
                    `).show();
                }
            } catch (error) {
                $('#seedResults').html(`
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle"></i> Error</h6>
                        ${error.statusText || error}
                    </div>
                `).show();
            } finally {
                $btn.html('<i class="bi bi-tags"></i> Update Categories').prop('disabled', false);
                setTimeout(function() {
                    $('#seedProgress').hide();
                    $('#seedProgressBar').css('width', '0%').addClass('progress-bar-animated');
                }, 2000);
            }
        });

        $('#seedBoardGamesBtn').on('click', async function() {
            const count = parseInt($('#seedCount').val()) || 200;

            if (!confirm(`This will import up to ${count} popular board games from BoardGameGeek.\n\nThis may take several minutes due to BGG API rate limiting.\n\nContinue?`)) {
                return;
            }

            const $btn = $(this);
            $btn.html('<span class="spinner-border spinner-border-sm"></span> Seeding...').prop('disabled', true);
            $('#seedProgress').show();
            $('#seedResults').hide();
            $('#seedProgressBar').css('width', '50%');
            $('#seedProgressText').text('Importing games from BGG (this may take a while)...');

            try {
                const response = await $.ajax({
                    url: '/Test/SeedBoardGames',
                    type: 'POST',
                    data: { count: count },
                    timeout: 600000 // 10 minutes
                });

                $('#seedProgressBar').css('width', '100%').removeClass('progress-bar-animated');

                if (response.success) {
                    $('#seedResults').html(`
                        <div class="alert alert-success">
                            <h6><i class="bi bi-check-circle"></i> ${response.message}</h6>
                            <strong>Before:</strong> ${response.existingBefore} games<br>
                            <strong>Added:</strong> ${response.added} games<br>
                            <strong>Total Now:</strong> ${response.totalNow} games
                        </div>
                    `).show();
                    loadBoardGamesCount();
                } else {
                    $('#seedResults').html(`
                        <div class="alert alert-danger">
                            <h6><i class="bi bi-x-circle"></i> Seeding Failed</h6>
                            ${response.message}
                        </div>
                    `).show();
                }
            } catch (error) {
                $('#seedResults').html(`
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle"></i> Error</h6>
                        ${error.statusText || error}
                    </div>
                `).show();
            } finally {
                $btn.html('<i class="bi bi-cloud-download"></i> Seed from BGG').prop('disabled', false);
                setTimeout(function() {
                    $('#seedProgress').hide();
                    $('#seedProgressBar').css('width', '0%').addClass('progress-bar-animated');
                }, 2000);
            }
        });

        // International cities for multi-select
        const intlCities = [
            { name: 'Hanoi', country: 'Vietnam', max: 15 },
            { name: 'Ho Chi Minh', country: 'Vietnam', max: 15 },
            { name: 'Da Nang', country: 'Vietnam', max: 15 },
            { name: 'Tokyo', country: 'Japan', max: 20 },
            { name: 'Osaka', country: 'Japan', max: 20 },
            { name: 'London', country: 'UK', max: 20 },
            { name: 'Toronto', country: 'Canada', max: 20 },
            { name: 'Vancouver', country: 'Canada', max: 20 },
            { name: 'Berlin', country: 'Germany', max: 20 },
            { name: 'Munich', country: 'Germany', max: 20 },
            { name: 'Paris', country: 'France', max: 20 },
            { name: 'Sydney', country: 'Australia', max: 20 },
            { name: 'Melbourne', country: 'Australia', max: 20 },
            { name: 'Singapore', country: 'Singapore', max: 20 },
            { name: 'Seoul', country: 'South Korea', max: 20 },
            { name: 'Bangkok', country: 'Thailand', max: 15 },
            { name: 'Amsterdam', country: 'Netherlands', max: 20 },
            { name: 'Prague', country: 'Czech Republic', max: 20 },
            { name: 'Barcelona', country: 'Spain', max: 20 },
            { name: 'Madrid', country: 'Spain', max: 20 }
        ];

        // Expanded US Cities list for batch crawl (100+ cities)
        const usCities = [
            // West Coast
            'Seattle, WA', 'Portland, OR', 'San Francisco, CA', 'Los Angeles, CA', 'San Diego, CA',
            'Sacramento, CA', 'San Jose, CA', 'Oakland, CA', 'Fresno, CA', 'Long Beach, CA',
            'Anaheim, CA', 'Irvine, CA', 'Santa Ana, CA', 'Riverside, CA', 'Pasadena, CA',
            'Berkeley, CA', 'Santa Barbara, CA', 'Santa Cruz, CA', 'Tacoma, WA', 'Spokane, WA',
            'Eugene, OR', 'Salem, OR', 'Boise, ID', 'Anchorage, AK', 'Honolulu, HI',
            // Southwest
            'Phoenix, AZ', 'Tucson, AZ', 'Mesa, AZ', 'Scottsdale, AZ', 'Las Vegas, NV',
            'Reno, NV', 'Albuquerque, NM', 'Santa Fe, NM', 'El Paso, TX',
            // Mountain
            'Denver, CO', 'Colorado Springs, CO', 'Boulder, CO', 'Fort Collins, CO',
            'Salt Lake City, UT', 'Provo, UT',
            // Texas
            'Austin, TX', 'Houston, TX', 'Dallas, TX', 'San Antonio, TX', 'Fort Worth, TX',
            'Arlington, TX', 'Plano, TX', 'Irving, TX', 'Frisco, TX', 'McKinney, TX',
            // Midwest
            'Chicago, IL', 'Detroit, MI', 'Minneapolis, MN', 'St. Paul, MN', 'Milwaukee, WI',
            'Madison, WI', 'Indianapolis, IN', 'Columbus, OH', 'Cleveland, OH', 'Cincinnati, OH',
            'St. Louis, MO', 'Kansas City, MO', 'Omaha, NE', 'Des Moines, IA', 'Wichita, KS',
            'Ann Arbor, MI', 'Grand Rapids, MI', 'Bloomington, IN', 'Champaign, IL',
            // Northeast
            'New York, NY', 'Brooklyn, NY', 'Queens, NY', 'Manhattan, NY', 'Boston, MA',
            'Cambridge, MA', 'Philadelphia, PA', 'Pittsburgh, PA', 'Baltimore, MD',
            'Washington, DC', 'Newark, NJ', 'Jersey City, NJ', 'Providence, RI', 'Hartford, CT',
            'New Haven, CT', 'Buffalo, NY', 'Rochester, NY', 'Syracuse, NY', 'Albany, NY',
            // Southeast
            'Atlanta, GA', 'Miami, FL', 'Orlando, FL', 'Tampa, FL', 'Jacksonville, FL',
            'Charlotte, NC', 'Raleigh, NC', 'Durham, NC', 'Nashville, TN', 'Memphis, TN',
            'Knoxville, TN', 'Louisville, KY', 'Lexington, KY', 'New Orleans, LA', 'Baton Rouge, LA',
            'Birmingham, AL', 'Charleston, SC', 'Savannah, GA', 'Richmond, VA', 'Virginia Beach, VA',
            'Norfolk, VA', 'Asheville, NC', 'Greenville, SC', 'Columbia, SC',
            // Additional metro areas
            'Oklahoma City, OK', 'Tulsa, OK', 'Little Rock, AR', 'Fayetteville, AR',
            'Portland, ME', 'Burlington, VT', 'Manchester, NH', 'Bozeman, MT', 'Missoula, MT'
        ];

        // Alternative search queries for more coverage
        const searchQueries = [
            'board game cafe',
            'tabletop game cafe',
            'gaming cafe board games',
            'board game bar',
            'tabletop gaming lounge'
        ];

        let isCrawling = false;
        let shouldStop = false;
        let totalStats = { added: 0, updated: 0, skipped: 0, errors: [] };
        let failedCities = [];

        // Populate multi-select checkboxes
        function populateCityCheckboxes() {
            // US Cities
            let usHtml = '';
            usCities.forEach((city, index) => {
                usHtml += `
                    <div class="col-md-3 col-sm-4 col-6 city-checkbox-item" data-region="us">
                        <div class="form-check">
                            <input class="form-check-input city-checkbox" type="checkbox"
                                   value="${city}" id="usCity${index}" data-region="us" data-max="15">
                            <label class="form-check-label small" for="usCity${index}">${city.split(',')[0]}</label>
                        </div>
                    </div>`;
            });
            $('#usCitiesCheckboxes').html(usHtml);

            // International Cities
            let intlHtml = '';
            intlCities.forEach((city, index) => {
                intlHtml += `
                    <div class="col-md-3 col-sm-4 col-6 city-checkbox-item" data-region="international">
                        <div class="form-check">
                            <input class="form-check-input city-checkbox" type="checkbox"
                                   value="${city.name}" id="intlCity${index}" data-region="international" data-max="${city.max}">
                            <label class="form-check-label small" for="intlCity${index}">
                                ${city.name} <small class="text-muted">(${city.country})</small>
                            </label>
                        </div>
                    </div>`;
            });
            $('#intlCitiesCheckboxes').html(intlHtml);
        }
        populateCityCheckboxes();

        // Populate Quick Crawl Buttons
        function populateQuickCrawlButtons() {
            // US Cities buttons
            let usHtml = '';
            usCities.forEach((city) => {
                const cityName = city.split(',')[0]; // Get city name without state
                usHtml += `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-2 quick-crawl-item" data-region="us">
                        <button class="btn btn-outline-primary btn-sm w-100 crawl-btn" data-location="${city}" data-max="15" title="${city}">
                            <i class="bi bi-download"></i> ${cityName}
                        </button>
                    </div>`;
            });
            $('#usQuickCrawlButtons').html(usHtml);
            $('#usQuickCount').text(usCities.length);

            // International Cities buttons
            let intlHtml = '';
            intlCities.forEach((city) => {
                intlHtml += `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-2 quick-crawl-item" data-region="international">
                        <button class="btn btn-outline-success btn-sm w-100 crawl-btn" data-location="${city.name}" data-max="${city.max}" title="${city.name}, ${city.country}">
                            <i class="bi bi-download"></i> ${city.name}
                        </button>
                    </div>`;
            });
            $('#intlQuickCrawlButtons').html(intlHtml);
            $('#intlQuickCount').text(intlCities.length);
        }
        populateQuickCrawlButtons();

        // Quick Crawl Search Filter
        $('#quickCrawlSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.quick-crawl-item').each(function() {
                const $item = $(this);
                const cityName = $item.find('button').data('location').toLowerCase();
                if (!searchTerm || cityName.includes(searchTerm)) {
                    $item.show();
                } else {
                    $item.hide();
                }
            });
        });

        // Update selected count
        function updateSelectedCityCount() {
            const count = $('.city-checkbox:checked').length;
            $('#selectedCityCount').text(count);
            $('#crawlSelectedCitiesBtn').prop('disabled', count === 0);
        }

        // Checkbox change event
        $(document).on('change', '.city-checkbox', updateSelectedCityCount);

        // Select All button
        $('#selectAllCitiesBtn').on('click', function() {
            const regionFilter = $('#regionFilter').val();
            const searchTerm = $('#citySearchInput').val().toLowerCase();

            $('.city-checkbox-item').each(function() {
                const $item = $(this);
                const $checkbox = $item.find('.city-checkbox');
                const region = $item.data('region');
                const isVisible = $item.is(':visible');

                if (isVisible && (regionFilter === 'all' || regionFilter === region)) {
                    $checkbox.prop('checked', true);
                }
            });
            updateSelectedCityCount();
        });

        // Deselect All button
        $('#deselectAllCitiesBtn').on('click', function() {
            $('.city-checkbox').prop('checked', false);
            updateSelectedCityCount();
        });

        // Region filter
        $('#regionFilter').on('change', function() {
            const region = $(this).val();
            $('.city-checkbox-item').each(function() {
                const $item = $(this);
                const itemRegion = $item.data('region');
                if (region === 'all' || region === itemRegion) {
                    $item.show();
                } else {
                    $item.hide();
                }
            });
        });

        // Search filter
        $('#citySearchInput').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            const region = $('#regionFilter').val();

            $('.city-checkbox-item').each(function() {
                const $item = $(this);
                const itemRegion = $item.data('region');
                const cityName = $item.find('label').text().toLowerCase();

                const matchesRegion = region === 'all' || region === itemRegion;
                const matchesSearch = !searchTerm || cityName.includes(searchTerm);

                if (matchesRegion && matchesSearch) {
                    $item.show();
                } else {
                    $item.hide();
                }
            });
        });

        // Crawl selected cities button
        $('#crawlSelectedCitiesBtn').on('click', async function() {
            const selectedCities = [];
            $('.city-checkbox:checked').each(function() {
                selectedCities.push($(this).val());
            });

            if (selectedCities.length === 0) {
                alert('Please select at least one city.');
                return;
            }

            if (!confirm(`Crawl ${selectedCities.length} selected city/cities?\n\nThis will crawl them sequentially with delays to avoid being blocked.\n\nContinue?`)) {
                return;
            }

            await startBatchCrawl(selectedCities);
        });

        // Crawl All US Cities
        $('#crawlAllUSBtn').on('click', async function() {
            if (!confirm('This will crawl ' + usCities.length + ' US cities sequentially with delays to avoid being blocked by Google.\n\nEstimated time: ' + estimateTime() + '\n\nContinue?')) {
                return;
            }
            await startBatchCrawl(usCities);
        });

        // Retry Failed Cities
        $('#retryFailedBtn').on('click', async function() {
            if (failedCities.length === 0) {
                alert('No failed cities to retry');
                return;
            }
            if (!confirm(`Retry ${failedCities.length} failed cities?`)) {
                return;
            }
            const citiesToRetry = [...failedCities];
            failedCities = [];
            await startBatchCrawl(citiesToRetry, true);
        });

        async function startBatchCrawl(cities, isRetry = false) {
            isCrawling = true;
            shouldStop = false;
            if (!isRetry) {
                totalStats = { added: 0, updated: 0, skipped: 0, errors: [] };
                failedCities = [];
            }

            const delay = parseInt($('#crawlDelay').val()) || 30;
            const maxPerCity = parseInt($('#crawlMaxPerCity').val()) || 15;
            const maxRetries = parseInt($('#crawlMaxRetries').val()) || 2;

            // UI Updates
            $('#crawlAllUSBtn').hide();
            $('#retryFailedBtn').hide();
            $('#stopCrawlBtn').show();
            $('#batchProgress').show();
            if (!isRetry) $('#batchLog').html('');
            $('.crawl-btn, #customCrawlBtn').prop('disabled', true);

            const startTime = Date.now();
            logMessage(`üöÄ Starting crawl for ${cities.length} cities`, 'info');

            for (let i = 0; i < cities.length; i++) {
                if (shouldStop) {
                    logMessage('‚õî Crawl stopped by user', 'warning');
                    break;
                }

                const city = cities[i];
                const progress = ((i + 1) / cities.length * 100).toFixed(1);

                updateProgress(progress, `Crawling ${city} (${i + 1}/${cities.length})`, startTime, i, cities.length);
                logMessage(`üîç Starting crawl for ${city}...`, 'info');

                let success = false;
                let lastError = '';

                for (let attempt = 0; attempt <= maxRetries && !success && !shouldStop; attempt++) {
                    if (attempt > 0) {
                        logMessage(`üîÑ Retry ${attempt}/${maxRetries} for ${city}...`, 'warning');
                        await sleep(5000);
                    }

                    try {
                        const result = await crawlCity(city, maxPerCity);

                        if (result.success !== false) {
                            totalStats.added += result.added || 0;
                            totalStats.updated += result.updated || 0;
                            totalStats.skipped += result.skipped || 0;

                            logMessage(`‚úÖ ${city}: +${result.added} added, ${result.updated} updated, ${result.skipped} skipped (crawled: ${result.totalCrawled})`, 'success');
                            success = true;
                        } else {
                            lastError = result.message || 'Unknown error';
                            logMessage(`‚ö†Ô∏è ${city} attempt ${attempt + 1}: ${lastError}`, 'warning');
                        }
                    } catch (error) {
                        lastError = error.toString();
                        logMessage(`‚ö†Ô∏è ${city} attempt ${attempt + 1}: ${lastError}`, 'warning');
                    }
                }

                if (!success) {
                    logMessage(`‚ùå ${city}: Failed after ${maxRetries + 1} attempts - ${lastError}`, 'error');
                    totalStats.errors.push(`${city}: ${lastError}`);
                    failedCities.push(city);
                }

                // Wait before next city
                if (i < cities.length - 1 && !shouldStop) {
                    logMessage(`‚è≥ Waiting ${delay} seconds...`, 'info');
                    await sleep(delay * 1000);
                }
            }

            // Completed
            isCrawling = false;
            $('#crawlAllUSBtn').show();
            $('#stopCrawlBtn').hide();
            $('.crawl-btn, #customCrawlBtn').prop('disabled', false);

            if (failedCities.length > 0) {
                $('#failedCount').text(failedCities.length);
                $('#retryFailedBtn').show();
            }

            updateProgress(100, 'Completed!', startTime, cities.length, cities.length);
            logMessage('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
            logMessage(`üìä TOTAL: ${totalStats.added} added, ${totalStats.updated} updated, ${totalStats.skipped} skipped`, 'success');
            if (totalStats.errors.length > 0) {
                logMessage(`‚ö†Ô∏è ${totalStats.errors.length} cities had errors`, 'warning');
            }

            // Show summary
            displayBatchResults();
        }

        // Stop button
        $('#stopCrawlBtn').on('click', function() {
            if (confirm('Are you sure you want to stop the crawl? Progress will be saved.')) {
                shouldStop = true;
                $(this).html('<span class="spinner-border spinner-border-sm"></span> Stopping...').prop('disabled', true);
            }
        });

        function estimateTime() {
            const delay = parseInt($('#crawlDelay').val()) || 30;
            const crawlTime = 60; // Approximate time per city in seconds
            const totalSeconds = usCities.length * (delay + crawlTime);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return hours > 0 ? `${hours}h ${minutes}m` : `${minutes} minutes`;
        }

        function crawlCity(location, maxResults) {
            return new Promise((resolve, reject) => {
                const payload = {
                    location: location,
                    maxResults: maxResults
                };

                $.ajax({
                    url: '/Test/CrawlAndSave',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    timeout: 600000, // 10 minute timeout
                    success: resolve,
                    error: function(xhr, status, error) {
                        reject(error || status);
                    }
                });
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateProgress(percent, text, startTime, completed, total) {
            $('#progressBar').css('width', percent + '%').text(Math.round(percent) + '%');
            $('#progressText').text(text);

            if (completed > 0 && completed < total) {
                const elapsed = (Date.now() - startTime) / 1000;
                const avgTime = elapsed / completed;
                const remaining = (total - completed) * avgTime;
                const mins = Math.floor(remaining / 60);
                const secs = Math.floor(remaining % 60);
                $('#progressEta').text(`ETA: ${mins}m ${secs}s remaining`);
            } else if (completed >= total) {
                $('#progressEta').text('Done!');
            }
        }

        function logMessage(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            let color = '#fff';
            if (type === 'success') color = '#28a745';
            if (type === 'error') color = '#dc3545';
            if (type === 'warning') color = '#ffc107';

            $('#batchLog').append(`<div style="color: ${color}">[${timestamp}] ${message}</div>`);
            $('#batchLog').scrollTop($('#batchLog')[0].scrollHeight);
        }

        function displayBatchResults() {
            let html = '<div class="alert alert-info mt-3">';
            html += '<h5><i class="bi bi-bar-chart"></i> Batch Crawl Summary</h5>';
            html += '<strong>Total Added:</strong> ' + totalStats.added + '<br>';
            html += '<strong>Total Updated:</strong> ' + totalStats.updated + '<br>';
            html += '<strong>Total Skipped:</strong> ' + totalStats.skipped + '<br>';
            html += '<strong>Cities with Errors:</strong> ' + totalStats.errors.length;
            html += '</div>';

            $('#resultsContent').html(html);
            $('#results').show();
        }

        $('.crawl-btn').on('click', function() {
            const location = $(this).data('location');
            const maxResults = $(this).data('max');
            crawlAndSave(location, maxResults);
        });

        $('#customCrawlBtn').on('click', function() {
            const location = $('#customLocation').val();
            const maxResults = parseInt($('#customMaxResults').val()) || 20;

            if (!location) {
                alert('Please enter a location');
                return;
            }

            crawlAndSave(location, maxResults);
        });

        $('#cleanFalsePositiveGamesBtn').on('click', function() {
            if (!confirm('This will remove false positive games (Sweet Spot, Wings, BLT, etc.) from the database.\n\nContinue?')) {
                return;
            }

            $('#cleanFalsePositiveGamesBtn').html('<span class="spinner-border spinner-border-sm"></span> Cleaning...').prop('disabled', true);

            $.ajax({
                url: '/Test/CleanFalsePositiveGames',
                type: 'POST',
                success: function(response) {
                    $('#cleanFalsePositiveGamesBtn').html('<i class="bi bi-x-circle"></i> Clean Games').prop('disabled', false);

                    if (response.success) {
                        let html = '<div class="alert alert-success">';
                        html += '<h5>' + response.message + '</h5>';
                        if (response.deletedGames && response.deletedGames.length > 0) {
                            html += '<strong>Deleted Games:</strong> ' + response.deletedGames.join(', ') + '<br>';
                        } else {
                            html += '<em>No false positive games found.</em>';
                        }
                        html += '</div>';

                        $('#resultsContent').html(html);
                        $('#results').show();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#cleanFalsePositiveGamesBtn').html('<i class="bi bi-x-circle"></i> Clean Games').prop('disabled', false);
                    alert('Error cleaning false positive games: ' + error);
                }
            });
        });

        // Fix Coordinates button handler
        $('#fixCoordinatesBtn').on('click', function() {
            if (!confirm('This will fix cafe coordinates by re-extracting from Google Maps URLs.\n\nThe @@lat,lng pattern is the map view center (wrong).\nThe !3d...!4d... pattern is the actual place location (correct).\n\nContinue?')) {
                return;
            }

            $('#fixCoordinatesBtn').html('<span class="spinner-border spinner-border-sm"></span> Fixing...').prop('disabled', true);

            $.ajax({
                url: '/Test/FixCoordinates',
                type: 'POST',
                success: function(response) {
                    $('#fixCoordinatesBtn').html('<i class="bi bi-geo-alt"></i> Fix Coords').prop('disabled', false);

                    if (response.success) {
                        let html = '<div class="alert alert-success">';
                        html += '<h5>' + response.message + '</h5>';
                        html += '<strong>Total Processed:</strong> ' + response.totalProcessed + '<br>';
                        html += '<strong>Fixed:</strong> ' + response.fixed + '<br>';
                        html += '<strong>Already Correct:</strong> ' + response.skipped + '<br>';
                        html += '<strong>No Pattern Found:</strong> ' + response.noPattern + '<br>';

                        if (response.fixedCafes && response.fixedCafes.length > 0) {
                            html += '<hr><strong>Fixed Cafes:</strong><ul class="mb-0">';
                            response.fixedCafes.forEach(function(cafe) {
                                html += '<li><strong>' + cafe.name + '</strong> (' + cafe.city + ')<br>';
                                html += '<small class="text-muted">Old: ' + cafe.oldLat + ', ' + cafe.oldLng + ' ‚Üí New: ' + cafe.newLat + ', ' + cafe.newLng + '</small></li>';
                            });
                            html += '</ul>';
                        }
                        html += '</div>';

                        $('#resultsContent').html(html);
                        $('#results').show();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#fixCoordinatesBtn').html('<i class="bi bi-geo-alt"></i> Fix Coords').prop('disabled', false);
                    alert('Error fixing coordinates: ' + error);
                }
            });
        });

        $('#cleanPhoneBtn').on('click', function() {
            if (!confirm('This will clean phone numbers in the database by removing special/control characters.\n\nContinue?')) {
                return;
            }

            $('#cleanPhoneBtn').html('<span class="spinner-border spinner-border-sm"></span> Cleaning...').prop('disabled', true);

            $.ajax({
                url: '/Test/CleanPhoneNumbers',
                type: 'POST',
                success: function(response) {
                    $('#cleanPhoneBtn').html('<i class="bi bi-telephone"></i> Clean Phones').prop('disabled', false);

                    if (response.success) {
                        let html = '<div class="alert alert-success">';
                        html += '<h5>' + response.message + '</h5>';
                        html += '<strong>Cafes Processed:</strong> ' + response.cafesProcessed + '<br>';
                        html += '<strong>Phone Numbers Updated:</strong> ' + response.updated;
                        html += '</div>';

                        $('#resultsContent').html(html);
                        $('#results').show();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#cleanPhoneBtn').html('<i class="bi bi-telephone"></i> Clean Phone Numbers').prop('disabled', false);
                    alert('Error cleaning phone numbers: ' + error);
                }
            });
        });

        $('#clearAllBtn').on('click', function() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL cafe data and related records (reviews, photos, events, etc.) from the database.\n\nBoard games whitelist will be PRESERVED by default.\n\nAre you absolutely sure you want to continue?')) {
                return;
            }

            // Ask about board games
            const deleteBoardGames = confirm('Do you also want to DELETE all board games from the whitelist?\n\nClick OK to DELETE board games\nClick Cancel to PRESERVE board games (recommended)');
            const preserveBoardGames = !deleteBoardGames;

            if (!confirm(`This action CANNOT be undone.\n\nBoard games will be: ${preserveBoardGames ? 'PRESERVED' : 'DELETED'}\n\nClick OK to proceed with deletion.`)) {
                return;
            }

            $('#clearAllBtn').html('<span class="spinner-border spinner-border-sm"></span> Deleting...').prop('disabled', true);

            $.ajax({
                url: '/Test/ClearAllData',
                type: 'POST',
                data: { preserveBoardGames: preserveBoardGames },
                success: function(response) {
                    $('#clearAllBtn').html('<i class="bi bi-trash"></i> Clear All Data').prop('disabled', false);

                    if (response.success) {
                        let html = '<div class="alert alert-success">';
                        html += '<h5>Data Cleared Successfully!</h5>';
                        html += '<p>' + response.message + '</p>';
                        html += '<strong>Deleted:</strong><br>';
                        html += 'Cafes: ' + response.deleted.cafes + '<br>';
                        html += 'Reviews: ' + response.deleted.reviews + '<br>';
                        html += 'Photos: ' + response.deleted.photos + '<br>';
                        html += 'Events: ' + response.deleted.events + '<br>';
                        html += 'Cafe-Games: ' + response.deleted.cafeGames + '<br>';
                        html += 'Premium Listings: ' + response.deleted.premiumListings + '<br>';
                        html += 'Board Games: ' + response.deleted.boardGames + '<br>';
                        html += 'Image Files: ' + response.deleted.imageFiles + '<br>';
                        if (response.boardGamesPreserved > 0) {
                            html += '<br><strong class="text-success">Board Games Preserved: ' + response.boardGamesPreserved + '</strong>';
                        }
                        html += '</div>';

                        $('#resultsContent').html(html);
                        $('#results').show();

                        // Refresh board games count
                        loadBoardGamesCount();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    $('#clearAllBtn').html('<i class="bi bi-trash"></i> Clear All Data').prop('disabled', false);
                    alert('Error clearing data: ' + error);
                }
            });
        });

        // BGG Sync All Cafes
        $('#syncAllBggBtn').on('click', async function() {
            if (!confirm('This will attempt to auto-discover BGG usernames for all cafes and sync their board game collections.\n\nThis may take a while. Continue?')) {
                return;
            }

            const $btn = $(this);
            $btn.html('<span class="spinner-border spinner-border-sm"></span> Syncing...').prop('disabled', true);
            $('#bggProgress').show();
            $('#bggLog').show().html('');
            $('#bggResults').hide();

            bggLogMessage('Starting BGG sync for all cafes...', 'info');

            try {
                const response = await $.ajax({
                    url: '/Test/SyncAllBgg',
                    type: 'POST',
                    timeout: 600000 // 10 minutes
                });

                bggLogMessage(`Completed! ${response.successfulSyncs}/${response.totalCafes} cafes synced successfully`, 'success');
                bggLogMessage(`Total games added: ${response.totalGamesAdded}, updated: ${response.totalGamesUpdated}`, 'success');

                // Show detailed results
                let html = `<strong>Total Cafes:</strong> ${response.totalCafes}<br>`;
                html += `<strong>Successful Syncs:</strong> ${response.successfulSyncs}<br>`;
                html += `<strong>Failed Syncs:</strong> ${response.failedSyncs}<br>`;
                html += `<strong>Total Games Added:</strong> ${response.totalGamesAdded}<br>`;
                html += `<strong>Total Games Updated:</strong> ${response.totalGamesUpdated}<br>`;

                if (response.results && response.results.length > 0) {
                    html += '<hr><strong>Details:</strong><br>';
                    response.results.forEach(r => {
                        const icon = r.success ? '‚úÖ' : '‚ùå';
                        html += `${icon} ${r.cafeName}: ${r.message} (${r.gamesAdded} added)<br>`;
                    });
                }

                $('#bggResultsContent').html(html);
                $('#bggResults').show();

            } catch (error) {
                bggLogMessage(`Error: ${error}`, 'error');
            } finally {
                $btn.html('<i class="bi bi-arrow-repeat"></i> Sync All Cafes (Auto-discover)').prop('disabled', false);
                $('#bggProgress').hide();
            }
        });

        // Test Find BGG Usernames
        $('#testBggUsernameBtn').on('click', async function() {
            const cafeName = $('#testCafeName').val();
            if (!cafeName) {
                alert('Please enter a cafe name');
                return;
            }

            const $btn = $(this);
            $btn.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);
            $('#bggLog').show();

            bggLogMessage(`Searching for BGG usernames matching: "${cafeName}"...`, 'info');

            try {
                const response = await $.ajax({
                    url: '/Test/FindBggUsernames',
                    data: { cafeName: cafeName },
                    timeout: 60000
                });

                if (response.possibleUsernames && response.possibleUsernames.length > 0) {
                    bggLogMessage(`Found ${response.possibleUsernames.length} possible username(s):`, 'success');
                    response.possibleUsernames.forEach(u => {
                        bggLogMessage(`  - ${u}`, 'success');
                    });
                } else {
                    bggLogMessage('No matching BGG usernames found', 'warning');
                }

            } catch (error) {
                bggLogMessage(`Error: ${error}`, 'error');
            } finally {
                $btn.html('<i class="bi bi-search"></i> Find BGG Users').prop('disabled', false);
            }
        });

        // Test View BGG Collection
        $('#testBggCollectionBtn').on('click', async function() {
            const username = $('#testBggUsername').val();
            if (!username) {
                alert('Please enter a BGG username');
                return;
            }

            const $btn = $(this);
            $btn.html('<span class="spinner-border spinner-border-sm"></span>').prop('disabled', true);
            $('#bggLog').show();

            bggLogMessage(`Fetching collection for BGG user: "${username}"...`, 'info');

            try {
                const response = await $.ajax({
                    url: '/Test/BggCollection',
                    data: { username: username },
                    timeout: 60000
                });

                bggLogMessage(`Found ${response.totalGames} games in collection`, 'success');

                if (response.games && response.games.length > 0) {
                    bggLogMessage('Sample games:', 'info');
                    response.games.slice(0, 10).forEach(g => {
                        bggLogMessage(`  - ${g.name} (${g.yearPublished || 'N/A'}) - ${g.minPlayers}-${g.maxPlayers} players`, 'success');
                    });
                    if (response.totalGames > 10) {
                        bggLogMessage(`  ... and ${response.totalGames - 10} more`, 'info');
                    }
                }

            } catch (error) {
                bggLogMessage(`Error: ${error}`, 'error');
            } finally {
                $btn.html('<i class="bi bi-list-ul"></i> View Collection').prop('disabled', false);
            }
        });

        function bggLogMessage(message, type) {
            const timestamp = new Date().toLocaleTimeString();
            let color = '#fff';
            if (type === 'success') color = '#28a745';
            if (type === 'error') color = '#dc3545';
            if (type === 'warning') color = '#ffc107';

            $('#bggLog').append(`<div style="color: ${color}">[${timestamp}] ${message}</div>`);
            $('#bggLog').scrollTop($('#bggLog')[0].scrollHeight);
        }

        function crawlAndSave(location, maxResults) {
            $('#loading').show();
            $('#currentLocation').text(location);
            $('#results').hide();
            $('.crawl-btn').prop('disabled', true);
            $('#customCrawlBtn').prop('disabled', true);

            $.ajax({
                url: '/Test/CrawlAndSave',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    location: location,
                    maxResults: maxResults
                }),
                timeout: 600000, // 10 minute timeout
                success: function(response) {
                    $('#loading').hide();
                    $('.crawl-btn').prop('disabled', false);
                    $('#customCrawlBtn').prop('disabled', false);

                    displayResults(response);
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    $('.crawl-btn').prop('disabled', false);
                    $('#customCrawlBtn').prop('disabled', false);

                    alert('Error: ' + error);
                }
            });
        }

        function displayResults(response) {
            let html = '<div class="alert alert-success">';
            html += '<h5>Crawl Complete!</h5>';
            html += '<strong>Location:</strong> ' + response.location + '<br>';
            html += '<strong>Total Crawled:</strong> ' + response.totalCrawled + '<br>';
            html += '<strong>Added:</strong> ' + response.added + '<br>';
            html += '<strong>Updated:</strong> ' + response.updated + '<br>';
            html += '<strong>Skipped:</strong> ' + response.skipped + '<br>';

            if (response.errors && response.errors.length > 0) {
                html += '<hr><strong>Errors:</strong><ul>';
                response.errors.forEach(function(error) {
                    html += '<li>' + error + '</li>';
                });
                html += '</ul>';
            }

            html += '</div>';

            $('#resultsContent').html(html);
            $('#results').show();

            // Scroll to results
            $('html, body').animate({
                scrollTop: $('#results').offset().top - 100
            }, 500);
        }
    });
</script>
}
