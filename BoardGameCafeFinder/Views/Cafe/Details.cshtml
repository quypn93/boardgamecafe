@model BoardGameCafeFinder.Models.Domain.Cafe
@{
    ViewData["Title"] = Model.Name;
    Layout = "_UserLayout";
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
        </ol>
    </nav>

    <!-- Header Info -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-4">@Model.Name</h1>
            <div class="mb-2">
                @if (Model.AverageRating > 0)
                {
                    <span class="badge bg-warning text-dark me-2">
                        <i class="bi bi-star-fill"></i> @Model.AverageRating.Value.ToString("0.0")
                    </span>
                    <span class="text-muted">(@Model.TotalReviews reviews)</span>
                }
                @if (!string.IsNullOrEmpty(Model.PriceRange))
                {
                    <span class="badge bg-secondary ms-2">@Model.PriceRange</span>
                }
            </div>
            <p class="lead">
                <i class="bi bi-geo-alt"></i> @Model.Address, @Model.City, @Model.State
            </p>
            @if (!string.IsNullOrEmpty(Model.Phone))
            {
                // Remove all non-ASCII and control characters
                var cleanPhone = System.Text.RegularExpressions.Regex.Replace(
                    Model.Phone,
                    @"[\x00-\x1F\x7F-\x9F\u0600-\u06FF\u200B-\u200F\u2028-\u2029\u202A-\u202E\u2060-\u206F]",
                    "").Trim();
                var telPhone = System.Text.RegularExpressions.Regex.Replace(cleanPhone, @"[^\d+]", "");
                <p>
                    <i class="bi bi-telephone"></i>
                    <a href="tel:@telPhone" class="text-decoration-none">@cleanPhone</a>
                </p>
            }
            @if (!string.IsNullOrEmpty(Model.Website))
            {
                <p>
                    <a href="@Model.Website" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-globe"></i> Visit Website
                    </a>
                    @if (!string.IsNullOrEmpty(Model.GoogleMapsUrl))
                    {
                        <a href="@Model.GoogleMapsUrl" target="_blank" class="btn btn-outline-success btn-sm ms-2">
                            <i class="bi bi-map"></i> View on Google Maps
                        </a>
                    }
                </p>
            }
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="mt-4">
                    <h5>About this place</h5>
                    <p class="text-muted">@Model.Description</p>
                </div>
            }
            @{
                @* var attributes = Model.GetAttributes();
                if (attributes != null && attributes.Any())
                {
                    <div class="mt-4">
                        <h5>Amenities & Features</h5>
                        <div class="row">
                            @foreach (var category in attributes)
                            {
                                <div class="col-md-6 mb-3">
                                    <h6 class="fw-bold">@category.Key</h6>
                                    <ul class="list-unstyled">
                                        @foreach (var item in category.Value)
                                        {
                                            <li><i class="bi bi-check-circle-fill text-success small"></i> @item</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    </div>
                } *@
            }
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Photos & Reviews -->
        <div class="col-lg-8">
            <!-- Photos Carousel -->
            @if (Model.Photos != null && Model.Photos.Any())
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white">
                        <h4 class="mb-0">Photos</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="cafeCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators">
                                @for (int i = 0; i < Model.Photos.Count; i++)
                                {
                                    <button type="button" data-bs-target="#cafeCarousel" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                                }
                            </div>
                            <div class="carousel-inner">
                                @{
                                    var photos = Model.Photos.OrderBy(p => p.DisplayOrder).ToList();
                                    for (int i = 0; i < photos.Count; i++)
                                    {
                                        var photoSrc = !string.IsNullOrEmpty(photos[i].LocalPath) ? photos[i].LocalPath : photos[i].Url;
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <div class="ratio ratio-16x9">
                                                <img src="@photoSrc" class="d-block w-100 object-fit-contain bg-dark" alt="Photo of @Model.Name">
                                            </div>
                                            @if (!string.IsNullOrEmpty(photos[i].Caption))
                                            {
                                                <div class="carousel-caption d-none d-md-block">
                                                    <p>@photos[i].Caption</p>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#cafeCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#cafeCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(Model.LocalImagePath))
            {
                 <div class="card mb-4 shadow-sm">
                    <div class="card-body p-0">
                         <div class="ratio ratio-16x9">
                             <img src="@Model.LocalImagePath" class="img-fluid rounded w-100 object-fit-cover" alt="@Model.Name">
                         </div>
                    </div>
                </div>
            }

            <!-- Board Game Library -->
            @if (Model.CafeGames != null && Model.CafeGames.Any())
            {
                <div class="card mb-4 shadow-sm border-0 bg-light">
                    <div class="card-header bg-white border-bottom-0 pt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="bi bi-controller me-2"></i>Board Game Library</h4>
                            <span class="badge bg-primary rounded-pill">@Model.CafeGames.Count Games</span>
                        </div>
                    </div>
                    <div class="card-body">
                        @{
                            var totalGames = Model.CafeGames.Count;
                            var gamesPerPage = 8;
                            var totalGamePages = (int)Math.Ceiling((double)totalGames / gamesPerPage);
                        }
                        <!-- Games Navigation Tabs -->
                        @if (totalGamePages > 1)
                        {
                            <div class="mb-3 d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" id="prevGamesBtn" type="button">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <span class="text-muted small" id="gamesPageInfo">Page 1 of @totalGamePages</span>
                                <button class="btn btn-sm btn-outline-secondary" id="nextGamesBtn" type="button">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        }
                        <!-- Games Grid with Pagination -->
                        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3" id="gamesContainer">
                            @{
                                var sortedGames = Model.CafeGames.OrderBy(cg => cg.Game.Name).ToList();
                                for (int i = 0; i < sortedGames.Count; i++)
                                {
                                    var cafeGame = sortedGames[i];
                                    var pageNumber = (i / gamesPerPage) + 1;
                                    <div class="col game-item" data-page="@pageNumber" style="display: @(pageNumber > 1 ? "none" : "block");">
                                        <div class="card h-100 border-0 shadow-sm text-center">
                                            <div class="p-2">
                                                @if (!string.IsNullOrEmpty(cafeGame.Game.ImageUrl))
                                                {
                                                    <img src="@cafeGame.Game.ImageUrl" class="card-img-top rounded object-fit-contain" style="height: 100px;" alt="@cafeGame.Game.Name">
                                                }
                                                else
                                                {
                                                    <div class="bg-secondary bg-opacity-10 rounded d-flex align-items-center justify-content-center" style="height: 100px;">
                                                        <i class="bi bi-dice-5 text-secondary display-6"></i>
                                                    </div>
                                                }
                                            </div>
                                            <div class="card-body p-2 d-flex flex-column">
                                                <h6 class="card-title small fw-bold mb-1 text-truncate" title="@cafeGame.Game.Name">@cafeGame.Game.Name</h6>
                                                <div class="mt-auto d-flex flex-column gap-1">
                                                    @if (cafeGame.Game.BGGId.HasValue)
                                                    {
                                                        <a href="https://boardgamegeek.com/boardgame/@cafeGame.Game.BGGId" target="_blank" class="text-decoration-none extra-small-link">
                                                            <i class="bi bi-box-arrow-up-right me-1"></i>BGG
                                                        </a>
                                                    }
                                                    @if (!string.IsNullOrEmpty(cafeGame.Game.AmazonAffiliateUrl))
                                                    {
                                                        <a href="@cafeGame.Game.AmazonAffiliateUrl" target="_blank" rel="nofollow sponsored" class="text-decoration-none extra-small-link text-warning">
                                                            <i class="bi bi-cart-fill me-1"></i>Buy
                                                        </a>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <!-- Games Pagination Bottom -->
                        @if (totalGamePages > 1)
                        {
                            <div class="mt-3 d-flex align-items-center justify-content-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" id="prevGamesBtnBottom" type="button">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <span class="text-muted small" id="gamesPageInfoBottom">Page 1 of @totalGamePages</span>
                                <button class="btn btn-sm btn-outline-secondary" id="nextGamesBtnBottom" type="button">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Reviews -->
            @{
                // Calculate actual visible review count
                var currentUserIdForCount = ViewBag.CurrentUserId as int?;
                var visibleReviewCount = Model.Reviews?
                    .Count(r => r.UserId == null || r.IsApproved || (currentUserIdForCount.HasValue && r.UserId == currentUserIdForCount.Value)) ?? 0;
            }
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Reviews</h4>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-secondary">Total: @visibleReviewCount</span>
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                <i class="bi bi-pencil-square me-1"></i> Write Review
                            </button>
                        }
                        else
                        {
                            <a href="/Account/Login?returnUrl=/cafe/@Model.Slug" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-box-arrow-in-right me-1"></i> Login to Review
                            </a>
                        }
                    </div>
                </div>

                <!-- Review Form (Collapsed by default) -->
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div class="collapse" id="reviewForm">
                        <div class="card-body border-bottom bg-light">
                            @if (TempData["Error"] != null)
                            {
                                <div class="alert alert-danger alert-dismissible fade show">
                                    <i class="bi bi-exclamation-triangle me-1"></i> @TempData["Error"]
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            }
                            @if (TempData["Success"] != null)
                            {
                                <div class="alert alert-success alert-dismissible fade show">
                                    <i class="bi bi-check-circle me-1"></i> @TempData["Success"]
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            }
                            <form asp-action="SubmitReview" asp-route-slug="@Model.Slug" method="post">
                                <h6 class="mb-3"><i class="bi bi-star me-1"></i> Share your experience at @Model.Name</h6>

                                <!-- Star Rating -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Your Rating <span class="text-danger">*</span></label>
                                    <div class="star-rating">
                                        @for (int i = 5; i >= 1; i--)
                                        {
                                            <input type="radio" name="rating" value="@i" id="star@(i)" required>
                                            <label for="star@(i)" title="@i stars"><i class="bi bi-star-fill"></i></label>
                                        }
                                    </div>
                                </div>

                                <!-- Review Title -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Title (optional)</label>
                                    <input type="text" name="title" class="form-control" placeholder="Sum up your experience" maxlength="200">
                                </div>

                                <!-- Review Content -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Your Review</label>
                                    <textarea name="content" class="form-control" rows="4" placeholder="Tell others about your visit..." maxlength="5000"></textarea>
                                </div>

                                <!-- Visit Date -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">When did you visit? (optional)</label>
                                    <input type="date" name="visitDate" class="form-control" max="@DateTime.Now.ToString("yyyy-MM-dd")">
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-send me-1"></i> Submit Review
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#reviewForm">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                }

                <div class="card-body">
                    @if (Model.Reviews != null && Model.Reviews.Any())
                    {
                        // Filter reviews: show crawled reviews (UserId=null) + approved reviews + current user's pending reviews
                        var currentUserId = ViewBag.CurrentUserId as int?;
                        var filteredReviews = Model.Reviews
                            .Where(r => r.UserId == null || r.IsApproved || (currentUserId.HasValue && r.UserId == currentUserId.Value))
                            .OrderByDescending(r => r.CreatedAt)
                            .ToList();

                        if (!filteredReviews.Any())
                        {
                            <p class="text-muted text-center py-4">No reviews yet.</p>
                        }
                        else
                        {
                        var allReviews = filteredReviews;
                        var reviewsPerPage = 5;
                        var totalReviewPages = (int)Math.Ceiling((double)allReviews.Count / reviewsPerPage);
                        <!-- Reviews Navigation -->
                        @if (totalReviewPages > 1)
                        {
                            <div class="mb-3 d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" id="prevReviewsBtn" type="button">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                    <span class="text-muted small" id="reviewsPageInfo">Page 1 of @totalReviewPages</span>
                                    <button class="btn btn-sm btn-outline-secondary" id="nextReviewsBtn" type="button">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                                <span class="text-muted small">Showing @reviewsPerPage per page</span>
                            </div>
                        }
                        <!-- Reviews List -->
                        <div class="list-group list-group-flush" id="reviewsContainer">
                            @for (int i = 0; i < allReviews.Count; i++)
                            {
                                var review = allReviews[i];
                                var pageNumber = (i / reviewsPerPage) + 1;
                                <div class="list-group-item px-0 py-3 review-item" data-page="@pageNumber" @(pageNumber > 1 ? "style=\"display: none;\"" : "")>
                                    <div class="d-flex justify-content-between mb-2">
                                        <div>
                                            <h6 class="mb-0 fw-bold">
                                                 @(review.User?.GetFullName() ?? review.Title?.Replace("Google Maps Review - ", "") ?? "Anonymous")
                                                 @if (review.UserId != null && review.UserId.ToString() == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                                                 {
                                                     <span class="badge bg-primary ms-1">You</span>
                                                     @if (!review.IsApproved)
                                                     {
                                                         <span class="badge bg-warning text-dark ms-1">Pending Approval</span>
                                                     }
                                                 }
                                            </h6>
                                            <small class="text-muted">@review.GetTimeAgo()</small>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="bg-light text-warning px-2 py-1 rounded">
                                                @review.Rating <i class="bi bi-star-fill"></i>
                                            </span>
                                            @if (review.UserId != null && (review.UserId.ToString() == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value || User.IsInRole("Admin")))
                                            {
                                                <form asp-action="DeleteReview" asp-route-slug="@Model.Slug" asp-route-reviewId="@review.ReviewId" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this review?');">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete review">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            }
                                        </div>
                                    </div>
                                    @{
                                        var maxLength = 300;
                                        var content = review.Content ?? "";
                                        var isLong = content.Length > maxLength;
                                    }
                                    @if (isLong)
                                    {
                                        <div class="review-content">
                                            <p class="mb-0 review-text-short">@content.Substring(0, maxLength)... <a href="#" class="read-more-link text-primary">Read more</a></p>
                                            <p class="mb-0 review-text-full d-none">@content <a href="#" class="read-less-link text-primary">Show less</a></p>
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="mb-0">@content</p>
                                    }
                                </div>
                            }
                        </div>
                        <!-- Reviews Pagination Bottom -->
                        @if (totalReviewPages > 1)
                        {
                            <div class="mt-3 d-flex align-items-center justify-content-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" id="prevReviewsBtnBottom" type="button">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <span class="text-muted small" id="reviewsPageInfoBottom">Page 1 of @totalReviewPages</span>
                                <button class="btn btn-sm btn-outline-secondary" id="nextReviewsBtnBottom" type="button">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        }
                        } @* End of else (filteredReviews.Any()) *@
                    }
                    else
                    {
                        <p class="text-muted text-center py-4">No reviews yet.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column: Map & Hours -->
        <div class="col-lg-4">
            <!-- Opening Hours -->
            @if (!string.IsNullOrEmpty(Model.OpeningHours))
            {
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Opening Hours</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text" style="white-space: pre-line;">@Model.OpeningHours.Replace(";", "\n")</p>
                    </div>
                </div>
            }
            <div class="card-body p-0">
                <div id="cafeMap" style="height: 300px; width: 100%; border-radius: 4px 4px 0 0;"></div>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrEmpty(Model.GoogleMapsUrl))
                {
                    <a href="@Model.GoogleMapsUrl" target="_blank" class="btn btn-primary w-100">
                        <i class="bi bi-map-fill"></i> Open in Google Maps
                    </a>
                }
                else
                {
                    <a href="https://www.google.com/maps/search/?api=1&query=@Model.Latitude,@Model.Longitude"
                        target="_blank" class="btn btn-primary w-100">
                        <i class="bi bi-map-fill"></i> Open in Google Maps
                    </a>
                }
            </div>
        </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        .extra-small-link {
            font-size: 0.7rem;
            color: #6c757d;
        }
        .extra-small-link:hover {
            color: #0d6efd;
        }

        /* Star Rating CSS */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 0.25rem;
        }
        .star-rating input {
            display: none;
        }
        .star-rating label {
            cursor: pointer;
            font-size: 1.75rem;
            color: #ddd;
            transition: color 0.2s;
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label,
        .star-rating input:checked ~ label {
            color: #ffc107;
        }
        .star-rating label i {
            display: inline-block;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            var lat = @Model.Latitude;
            var lng = @Model.Longitude;
            var cafeName = "@Html.Raw(Model.Name.Replace("\"", "\\\""))";

            var map = L.map('cafeMap').setView([lat, lng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([lat, lng]).addTo(map)
                .bindPopup('<b>' + cafeName + '</b>')
                .openPopup();

            // Games Pagination
            var currentGamePage = 1;
            var totalGamePages = @{
                var totalGames = Model.CafeGames?.Count ?? 0;
                var gamesPerPage = 8;
                var gamePages = (int)Math.Ceiling((double)totalGames / gamesPerPage);
                @gamePages
            };

            function updateGamePage() {
                document.querySelectorAll('.game-item').forEach(item => {
                    item.style.display = parseInt(item.dataset.page) === currentGamePage ? 'block' : 'none';
                });
                // Update top pagination
                var topPageInfo = document.getElementById('gamesPageInfo');
                var topPrevBtn = document.getElementById('prevGamesBtn');
                var topNextBtn = document.getElementById('nextGamesBtn');
                if (topPageInfo) topPageInfo.textContent = 'Page ' + currentGamePage + ' of ' + totalGamePages;
                if (topPrevBtn) topPrevBtn.disabled = currentGamePage === 1;
                if (topNextBtn) topNextBtn.disabled = currentGamePage === totalGamePages;

                // Update bottom pagination
                var bottomPageInfo = document.getElementById('gamesPageInfoBottom');
                var bottomPrevBtn = document.getElementById('prevGamesBtnBottom');
                var bottomNextBtn = document.getElementById('nextGamesBtnBottom');
                if (bottomPageInfo) bottomPageInfo.textContent = 'Page ' + currentGamePage + ' of ' + totalGamePages;
                if (bottomPrevBtn) bottomPrevBtn.disabled = currentGamePage === 1;
                if (bottomNextBtn) bottomNextBtn.disabled = currentGamePage === totalGamePages;
            }

            if (totalGamePages > 1) {
                // Top pagination buttons
                document.getElementById('prevGamesBtn')?.addEventListener('click', function() {
                    if (currentGamePage > 1) {
                        currentGamePage--;
                        updateGamePage();
                    }
                });

                document.getElementById('nextGamesBtn')?.addEventListener('click', function() {
                    if (currentGamePage < totalGamePages) {
                        currentGamePage++;
                        updateGamePage();
                    }
                });

                // Bottom pagination buttons
                document.getElementById('prevGamesBtnBottom')?.addEventListener('click', function() {
                    if (currentGamePage > 1) {
                        currentGamePage--;
                        updateGamePage();
                        // Scroll to top of games
                        document.getElementById('gamesContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });

                document.getElementById('nextGamesBtnBottom')?.addEventListener('click', function() {
                    if (currentGamePage < totalGamePages) {
                        currentGamePage++;
                        updateGamePage();
                        // Scroll to top of games
                        document.getElementById('gamesContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });

                // Initialize button states
                updateGamePage();
            }

            // Reviews Pagination
            var currentReviewPage = 1;
            var totalReviewPages = @{
                // Filter reviews same as in HTML: crawled (UserId=null) + approved + current user's pending reviews
                var jsCurrentUserId = ViewBag.CurrentUserId as int?;
                var jsFilteredReviews = Model.Reviews?
                    .Where(r => r.UserId == null || r.IsApproved || (jsCurrentUserId.HasValue && r.UserId == jsCurrentUserId.Value))
                    .ToList() ?? new List<BoardGameCafeFinder.Models.Domain.Review>();
                var totalReviews = jsFilteredReviews.Count;
                var reviewsPerPage = 5;
                var reviewPages = (int)Math.Ceiling((double)totalReviews / reviewsPerPage);
                @reviewPages
            };

            function updateReviewPage() {
                document.querySelectorAll('.review-item').forEach(item => {
                    item.style.display = parseInt(item.dataset.page) === currentReviewPage ? 'block' : 'none';
                });
                // Update top pagination
                var topPageInfo = document.getElementById('reviewsPageInfo');
                var topPrevBtn = document.getElementById('prevReviewsBtn');
                var topNextBtn = document.getElementById('nextReviewsBtn');
                if (topPageInfo) topPageInfo.textContent = 'Page ' + currentReviewPage + ' of ' + totalReviewPages;
                if (topPrevBtn) topPrevBtn.disabled = currentReviewPage === 1;
                if (topNextBtn) topNextBtn.disabled = currentReviewPage === totalReviewPages;

                // Update bottom pagination
                var bottomPageInfo = document.getElementById('reviewsPageInfoBottom');
                var bottomPrevBtn = document.getElementById('prevReviewsBtnBottom');
                var bottomNextBtn = document.getElementById('nextReviewsBtnBottom');
                if (bottomPageInfo) bottomPageInfo.textContent = 'Page ' + currentReviewPage + ' of ' + totalReviewPages;
                if (bottomPrevBtn) bottomPrevBtn.disabled = currentReviewPage === 1;
                if (bottomNextBtn) bottomNextBtn.disabled = currentReviewPage === totalReviewPages;
            }

            if (totalReviewPages > 1) {
                // Top pagination buttons
                document.getElementById('prevReviewsBtn')?.addEventListener('click', function() {
                    if (currentReviewPage > 1) {
                        currentReviewPage--;
                        updateReviewPage();
                    }
                });

                document.getElementById('nextReviewsBtn')?.addEventListener('click', function() {
                    if (currentReviewPage < totalReviewPages) {
                        currentReviewPage++;
                        updateReviewPage();
                    }
                });

                // Bottom pagination buttons
                document.getElementById('prevReviewsBtnBottom')?.addEventListener('click', function() {
                    if (currentReviewPage > 1) {
                        currentReviewPage--;
                        updateReviewPage();
                        // Scroll to top of reviews
                        document.getElementById('reviewsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });

                document.getElementById('nextReviewsBtnBottom')?.addEventListener('click', function() {
                    if (currentReviewPage < totalReviewPages) {
                        currentReviewPage++;
                        updateReviewPage();
                        // Scroll to top of reviews
                        document.getElementById('reviewsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });

                // Initialize button states
                updateReviewPage();
            }

            // Read more / Show less for reviews
            document.querySelectorAll('.read-more-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const container = this.closest('.review-content');
                    container.querySelector('.review-text-short').classList.add('d-none');
                    container.querySelector('.review-text-full').classList.remove('d-none');
                });
            });

            document.querySelectorAll('.read-less-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const container = this.closest('.review-content');
                    container.querySelector('.review-text-short').classList.remove('d-none');
                    container.querySelector('.review-text-full').classList.add('d-none');
                });
            });
        });
    </script>
}
