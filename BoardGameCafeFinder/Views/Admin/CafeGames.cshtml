@model BoardGameCafeFinder.Models.Domain.Cafe
@{
    ViewData["Title"] = $"Games - {Model.Name}";
    Layout = "_AdminLayout";
    var games = Model.CafeGames?.OrderBy(cg => cg.Game?.Name).ToList() ?? new List<BoardGameCafeFinder.Models.Domain.CafeGame>();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="/Test/Cafes" class="btn btn-outline-secondary btn-sm mb-2">
            <i class="bi bi-arrow-left me-1"></i> Back to List
        </a>
        <h2><i class="bi bi-controller me-2"></i>@Model.Name - Board Games</h2>
        <p class="text-muted mb-0">
            <i class="bi bi-geo-alt me-1"></i>@Model.City
            @if (!string.IsNullOrEmpty(Model.BggUsername))
            {
                <span class="ms-3"><i class="bi bi-link-45deg me-1"></i>BGG: @Model.BggUsername</span>
            }
        </p>
    </div>
    <div class="d-flex gap-2">
        @if (games.Any())
        {
            <button type="button" class="btn btn-warning" id="deleteSelectedBtn" style="display: none;"
                    onclick="deleteSelectedGames()">
                <i class="bi bi-trash me-1"></i> Delete Selected (<span id="selectedCount">0</span>)
            </button>
            <form asp-action="DeleteAllCafeGames" method="post" class="d-inline"
                  onsubmit="return confirm('Delete ALL @(games.Count) games from this cafe? This cannot be undone.');">
                <input type="hidden" name="cafeId" value="@Model.CafeId" />
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i> Delete All Games
                </button>
            </form>
        }
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card shadow-sm border-0">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>Game List
            <span class="badge bg-primary ms-2">@games.Count games</span>
        </h5>
        <div>
            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search games..." style="width: 200px;">
        </div>
    </div>
    <div class="card-body p-0">
        @if (!games.Any())
        {
            <div class="text-center py-5 text-muted">
                <i class="bi bi-inbox display-4"></i>
                <p class="mt-3">No games found for this cafe.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="gamesTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" title="Select All">
                            </th>
                            <th style="width: 60px;"></th>
                            <th>Game Name</th>
                            <th>BGG ID</th>
                            <th>Affiliate</th>
                            <th>Players</th>
                            <th>Playtime</th>
                            <th>Price</th>
                            <th class="text-center" style="width: 100px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cg in games)
                        {
                            var game = cg.Game;
                            if (game == null) continue;
                            <tr class="game-row">
                                <td>
                                    <input type="checkbox" class="form-check-input game-checkbox"
                                           value="@game.GameId" data-game-name="@game.Name">
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(game.ImageUrl))
                                    {
                                        <img src="@game.ImageUrl" alt="@game.Name"
                                             class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                                    }
                                    else
                                    {
                                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center"
                                             style="width: 50px; height: 50px;">
                                            <i class="bi bi-image text-white"></i>
                                        </div>
                                    }
                                </td>
                                <td>
                                    <div class="fw-bold game-name">@game.Name</div>
                                    @if (!string.IsNullOrEmpty(game.SourceUrl))
                                    {
                                        <small>
                                            <a href="@game.SourceUrl" target="_blank" class="text-muted">
                                                <i class="bi bi-box-arrow-up-right me-1"></i>Source
                                            </a>
                                        </small>
                                    }
                                </td>
                                <td>
                                    @if (game.BGGId.HasValue)
                                    {
                                        <a href="https://boardgamegeek.com/boardgame/@game.BGGId" target="_blank"
                                           class="badge bg-info text-decoration-none">
                                            @game.BGGId
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(game.AmazonAffiliateUrl) || !string.IsNullOrEmpty(game.MiniatureMarketAffiliateUrl))
                                    {
                                        <div class="d-flex gap-1 flex-wrap">
                                            @if (!string.IsNullOrEmpty(game.AmazonAffiliateUrl))
                                            {
                                                <a href="@game.AmazonAffiliateUrl" target="_blank" rel="nofollow sponsored"
                                                   class="badge bg-warning text-dark text-decoration-none" title="Amazon">
                                                    AMZ
                                                </a>
                                            }
                                            @if (!string.IsNullOrEmpty(game.MiniatureMarketAffiliateUrl))
                                            {
                                                <a href="@game.MiniatureMarketAffiliateUrl" target="_blank" rel="nofollow sponsored"
                                                   class="badge bg-primary text-decoration-none" title="Miniature Market">
                                                    MM
                                                </a>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (game.MinPlayers.HasValue || game.MaxPlayers.HasValue)
                                    {
                                        <span>@game.GetPlayerRange()</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (game.PlaytimeMinutes.HasValue)
                                    {
                                        <span>@game.GetPlaytime()</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (game.Price.HasValue)
                                    {
                                        <span class="text-success fw-bold">$@game.Price.Value.ToString("N2")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <form asp-action="DeleteCafeGame" method="post" class="d-inline delete-form"
                                          data-game-name="@game.Name">
                                        <input type="hidden" name="cafeId" value="@Model.CafeId" />
                                        <input type="hidden" name="gameId" value="@game.GameId" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
    // Search functionality
    document.getElementById('searchInput')?.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.game-row');

        rows.forEach(row => {
            const gameName = row.querySelector('.game-name')?.textContent.toLowerCase() || '';
            row.style.display = gameName.includes(searchTerm) ? '' : 'none';
        });
    });

    // Delete confirmation
    document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const gameName = this.dataset.gameName || 'this game';
            if (!confirm(`Delete "${gameName}" from this cafe?`)) {
                e.preventDefault();
            }
        });
    });

    // Select All checkbox
    document.getElementById('selectAllCheckbox')?.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.game-checkbox');
        checkboxes.forEach(cb => {
            // Only toggle visible checkboxes
            const row = cb.closest('.game-row');
            if (row && row.style.display !== 'none') {
                cb.checked = this.checked;
            }
        });
        updateSelectedCount();
    });

    // Individual checkbox change
    document.querySelectorAll('.game-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            updateSelectedCount();
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.game-checkbox');
            const checkedCount = document.querySelectorAll('.game-checkbox:checked').length;
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                selectAll.checked = checkedCount === allCheckboxes.length;
                selectAll.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
            }
        });
    });

    function updateSelectedCount() {
        const count = document.querySelectorAll('.game-checkbox:checked').length;
        const btn = document.getElementById('deleteSelectedBtn');
        const countSpan = document.getElementById('selectedCount');
        if (btn && countSpan) {
            countSpan.textContent = count;
            btn.style.display = count > 0 ? 'inline-block' : 'none';
        }
    }

    function deleteSelectedGames() {
        const checkboxes = document.querySelectorAll('.game-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('No games selected.');
            return;
        }

        const gameNames = Array.from(checkboxes).map(cb => cb.dataset.gameName).slice(0, 5);
        let message = `Delete ${checkboxes.length} selected game(s)?\n\n`;
        message += gameNames.join('\n');
        if (checkboxes.length > 5) {
            message += `\n... and ${checkboxes.length - 5} more`;
        }
        message += '\n\nThis cannot be undone.';

        if (!confirm(message)) {
            return;
        }

        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/Admin/DeleteSelectedCafeGames';

        const cafeIdInput = document.createElement('input');
        cafeIdInput.type = 'hidden';
        cafeIdInput.name = 'cafeId';
        cafeIdInput.value = '@Model.CafeId';
        form.appendChild(cafeIdInput);

        checkboxes.forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'gameIds';
            input.value = cb.value;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    }
</script>
}
