@model BoardGameCafeFinder.Models.Domain.User
@{
    ViewData["Title"] = "Edit User";
    Layout = "_AdminLayout";
    var userRoles = ViewBag.UserRoles as List<string> ?? new List<string>();
    var allRoles = ViewBag.AllRoles as List<string?> ?? new List<string?>();
    var cafes = ViewBag.Cafes as List<BoardGameCafeFinder.Models.Domain.Cafe> ?? new List<BoardGameCafeFinder.Models.Domain.Cafe>();
    var isLocked = Model.LockoutEnd != null && Model.LockoutEnd > DateTimeOffset.UtcNow;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="@Url.Action("Users")" class="btn btn-outline-secondary btn-sm me-2">
            <i class="bi bi-arrow-left"></i> Back to Users
        </a>
        <h2 class="d-inline-block mb-0"><i class="bi bi-person-gear me-2"></i>Edit User</h2>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row">
    <!-- User Info Card -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                @if (!string.IsNullOrEmpty(Model.AvatarUrl))
                {
                    <img src="@Model.AvatarUrl" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;">
                }
                else
                {
                    <div class="rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center text-white"
                         style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 32px;">
                        @(Model.FirstName?.FirstOrDefault())@(Model.LastName?.FirstOrDefault())
                    </div>
                }
                <h5 class="mb-1">@Model.GetFullName()</h5>
                <p class="text-muted mb-2">@Model.Email</p>

                <!-- Status Badges -->
                <div class="mb-3">
                    @if (isLocked)
                    {
                        <span class="badge bg-warning text-dark me-1"><i class="bi bi-lock-fill"></i> Locked</span>
                    }
                    else
                    {
                        <span class="badge bg-success me-1"><i class="bi bi-check-circle"></i> Active</span>
                    }
                    @if (Model.EmailConfirmed)
                    {
                        <span class="badge bg-info me-1"><i class="bi bi-envelope-check"></i> Email Verified</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary me-1"><i class="bi bi-envelope-x"></i> Email Not Verified</span>
                    }
                </div>

                <!-- Current Roles -->
                <div class="mb-3">
                    @foreach (var role in userRoles)
                    {
                        var badgeClass = role == "Admin" ? "bg-danger" : (role == "CafeOwner" ? "bg-success" : "bg-secondary");
                        <span class="badge @badgeClass me-1">@role</span>
                    }
                </div>

                <hr>

                <!-- Stats -->
                <div class="row text-center">
                    <div class="col-4">
                        <div class="h5 mb-0">@Model.TotalReviews</div>
                        <small class="text-muted">Reviews</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 mb-0">@Model.TotalBookings</div>
                        <small class="text-muted">Bookings</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 mb-0">@Model.ReputationScore</div>
                        <small class="text-muted">Points</small>
                    </div>
                </div>

                <hr>

                <!-- Dates -->
                <div class="small text-muted text-start">
                    <p class="mb-1"><strong>Created:</strong> @Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")</p>
                    <p class="mb-1">
                        <strong>Last Login:</strong>
                        @if (Model.LastLoginAt.HasValue)
                        {
                            @Model.LastLoginAt.Value.ToString("MMM dd, yyyy HH:mm")
                        }
                        else
                        {
                            <span>Never</span>
                        }
                    </p>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    @if (!Model.EmailConfirmed)
                    {
                        <form asp-action="ConfirmUserEmail" asp-route-id="@Model.Id" method="post">
                            <button type="submit" class="btn btn-outline-info w-100" onclick="return confirm('Confirm email for this user?');">
                                <i class="bi bi-envelope-check me-1"></i> Confirm Email
                            </button>
                        </form>
                    }

                    <form asp-action="ToggleUserLockout" asp-route-id="@Model.Id" method="post">
                        @if (isLocked)
                        {
                            <button type="submit" class="btn btn-outline-success w-100" onclick="return confirm('Unlock this user?');">
                                <i class="bi bi-unlock me-1"></i> Unlock User
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-outline-warning w-100" onclick="return confirm('Lock this user? They will not be able to login.');">
                                <i class="bi bi-lock me-1"></i> Lock User
                            </button>
                        }
                    </form>

                    @if (!userRoles.Contains("Admin"))
                    {
                        <form asp-action="DeleteUser" asp-route-id="@Model.Id" method="post">
                            <button type="submit" class="btn btn-outline-danger w-100"
                                    onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                                <i class="bi bi-trash me-1"></i> Delete User
                            </button>
                        </form>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-person me-2"></i>User Information</h5>
            </div>
            <div class="card-body">
                <form asp-action="UpdateUser" method="post">
                    <input type="hidden" name="id" value="@Model.Id" />

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="firstName" value="@Model.FirstName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="lastName" value="@Model.LastName" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-control" name="displayName" value="@Model.DisplayName">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" value="@Model.Email" disabled>
                            <small class="text-muted">Email cannot be changed</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="city" value="@Model.City">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Country</label>
                            <input type="text" class="form-control" name="country" value="@Model.Country">
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Cafe Owner Section -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="isCafeOwner" id="isCafeOwner"
                                   value="true" @(Model.IsCafeOwner ? "checked" : "")>
                            <label class="form-check-label" for="isCafeOwner">
                                <i class="bi bi-shop me-1"></i> Is Cafe Owner
                            </label>
                        </div>
                    </div>

                    <div class="mb-3" id="cafeSelectDiv" style="display: @(Model.IsCafeOwner ? "block" : "none");">
                        <label class="form-label">Assigned Cafe</label>
                        <select class="form-select" name="cafeId">
                            <option value="">-- Select Cafe --</option>
                            @foreach (var cafe in cafes)
                            {
                                if (Model.CafeId == cafe.CafeId)
                                {
                                    <option value="@cafe.CafeId" selected>@cafe.Name (@cafe.City)</option>
                                }
                                else
                                {
                                    <option value="@cafe.CafeId">@cafe.Name (@cafe.City)</option>
                                }
                            }
                        </select>
                    </div>

                    <hr class="my-4">

                    <!-- Roles Section -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-shield me-1"></i>Roles</label>
                        <div class="row">
                            @foreach (var role in allRoles.Where(r => r != null))
                            {
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" name="roles" id="role_@role"
                                               value="@role" @(userRoles.Contains(role!) ? "checked" : "")>
                                        <label class="form-check-label" for="role_@role">
                                            @if (role == "Admin")
                                            {
                                                <span class="badge bg-danger">@role</span>
                                            }
                                            else if (role == "CafeOwner")
                                            {
                                                <span class="badge bg-success">@role</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@role</span>
                                            }
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="@Url.Action("Users")" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reset Password Card -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-key me-2"></i>Reset Password</h5>
            </div>
            <div class="card-body">
                <form asp-action="ResetUserPassword" method="post">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" name="newPassword"
                                   minlength="8" placeholder="Enter new password (min 8 characters)" required>
                            <small class="text-muted">Password must be at least 8 characters with uppercase, lowercase, and a number.</small>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-warning w-100"
                                    onclick="return confirm('Reset password for this user?');">
                                <i class="bi bi-key me-1"></i> Reset Password
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- User Reviews Card -->
        @if (Model.Reviews?.Any() == true)
        {
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Recent Reviews (@Model.Reviews.Count)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Cafe</th>
                                    <th>Rating</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt).Take(10))
                                {
                                    <tr>
                                        <td>Review #@review.ReviewId</td>
                                        <td>
                                            <span class="badge bg-warning text-dark">
                                                @review.Rating <i class="bi bi-star-fill"></i>
                                            </span>
                                        </td>
                                        <td>@review.CreatedAt.ToString("MMM dd, yyyy")</td>
                                        <td>
                                            @if (review.IsApproved)
                                            {
                                                <span class="badge bg-success">Approved</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark">Pending</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isCafeOwnerCheckbox = document.getElementById('isCafeOwner');
            const cafeSelectDiv = document.getElementById('cafeSelectDiv');

            isCafeOwnerCheckbox.addEventListener('change', function() {
                cafeSelectDiv.style.display = this.checked ? 'block' : 'none';
            });
        });
    </script>
}
