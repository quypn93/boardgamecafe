@model BoardGameCafeFinder.Models.Domain.Cafe
@{
    ViewData["Title"] = $"{Model.Name} - Board Game Cafe in {Model.City}";
    ViewData["MetaDescription"] = !string.IsNullOrEmpty(Model.Description)
        ? (Model.Description.Length > 160 ? Model.Description.Substring(0, 157) + "..." : Model.Description)
        : $"Visit {Model.Name} in {Model.City}, {Model.State}. Explore their board game library with {Model.CafeGames?.Count ?? 0}+ games. Check hours, reviews, and directions.";
    ViewData["CanonicalUrl"] = $"{Context.Request.Scheme}://{Context.Request.Host}/Home/Details/{Model.CafeId}";
    Layout = "_UserLayout";

    var gameCount = Model.CafeGames?.Count ?? 0;
    var hasGames = gameCount > 0;
    var reviewCount = Model.TotalReviews;
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
        </ol>
    </nav>

    <!-- Header Info -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-4">@Model.Name</h1>
            <div class="mb-2">
                @if (Model.AverageRating > 0)
                {
                    <span class="badge bg-warning text-dark me-2">
                        <i class="bi bi-star-fill"></i> @Model.AverageRating.Value.ToString("0.0")
                    </span>
                    <span class="text-muted">(@Model.TotalReviews reviews)</span>
                }
                @if (!string.IsNullOrEmpty(Model.PriceRange))
                {
                    <span class="badge bg-secondary ms-2">@Model.PriceRange</span>
                }
                @* @if (Model.IsOpenNow())
                {
                    <span class="badge bg-success ms-2">Open Now</span>
                }
                else
                {
                    <span class="badge bg-danger ms-2">Closed</span>
                } *@
            </div>
            <p class="lead">
                <i class="bi bi-geo-alt"></i> @Model.Address, @Model.City, @Model.State
            </p>
            @if (!string.IsNullOrEmpty(Model.Phone))
            {
                // Remove all non-ASCII and control characters
                var cleanPhone = System.Text.RegularExpressions.Regex.Replace(
                    Model.Phone,
                    @"[\x00-\x1F\x7F-\x9F\u0600-\u06FF\u200B-\u200F\u2028-\u2029\u202A-\u202E\u2060-\u206F]",
                    "").Trim();
                var telPhone = System.Text.RegularExpressions.Regex.Replace(cleanPhone, @"[^\d+]", "");
                <p>
                    <i class="bi bi-telephone"></i>
                    <a href="tel:@telPhone" class="text-decoration-none">@cleanPhone</a>
                </p>
            }
            @if (!string.IsNullOrEmpty(Model.Website))
            {
                <p>
                    <a href="@Model.Website" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-globe"></i> Visit Website
                    </a>
                    @if (!string.IsNullOrEmpty(Model.GoogleMapsUrl))
                    {
                        <a href="@Model.GoogleMapsUrl" target="_blank" class="btn btn-outline-success btn-sm ms-2">
                            <i class="bi bi-map"></i> View on Google Maps
                        </a>
                    }
                </p>
            }
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="mt-4">
                    <h5>About this place</h5>
                    <p class="text-muted">@Model.Description</p>
                </div>
            }
            @{
                var attributes = Model.GetAttributes();
                if (attributes != null && attributes.Any())
                {
                    <div class="mt-4">
                        <h5>Amenities & Features</h5>
                        <div class="row">
                            @foreach (var category in attributes)
                            {
                                <div class="col-md-6 mb-3">
                                    <h6 class="fw-bold">@category.Key</h6>
                                    <ul class="list-unstyled">
                                        @foreach (var item in category.Value)
                                        {
                                            <li><i class="bi bi-check-circle-fill text-success small"></i> @item</li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Photos & Reviews -->
        <div class="col-lg-8">
            <!-- Photos Carousel -->
            @if (Model.Photos != null && Model.Photos.Any())
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white">
                        <h4 class="mb-0">Photos</h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="cafeCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators">
                                @for (int i = 0; i < Model.Photos.Count; i++)
                                {
                                    <button type="button" data-bs-target="#cafeCarousel" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")" aria-label="Slide @(i + 1)"></button>
                                }
                            </div>
                            <div class="carousel-inner">
                                @{
                                    var photos = Model.Photos.OrderBy(p => p.DisplayOrder).ToList();
                                    for (int i = 0; i < photos.Count; i++)
                                    {
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <div class="ratio ratio-16x9">
                                                <img src="@photos[i].Url" class="d-block w-100 object-fit-contain bg-dark" alt="Photo of @Model.Name">
                                            </div>
                                            @if (!string.IsNullOrEmpty(photos[i].Caption))
                                            {
                                                <div class="carousel-caption d-none d-md-block">
                                                    <p>@photos[i].Caption</p>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#cafeCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#cafeCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    </div>
                </div>
            }
            else if (!string.IsNullOrEmpty(Model.LocalImagePath))
            {
                 <div class="card mb-4 shadow-sm">
                    <div class="card-body p-0">
                         <div class="ratio ratio-16x9">
                             <img src="@Model.LocalImagePath" class="img-fluid rounded w-100 object-fit-cover" alt="@Model.Name">
                         </div>
                    </div>
                </div>
            }

            <!-- Board Game Library -->
            @if (Model.CafeGames != null && Model.CafeGames.Any())
            {
                <div class="card mb-4 shadow-sm border-0 bg-light">
                    <div class="card-header bg-white border-bottom-0 pt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="bi bi-controller me-2"></i>Board Game Library</h4>
                            <span class="badge bg-primary rounded-pill">@Model.CafeGames.Count Games</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
                            @foreach (var cafeGame in Model.CafeGames.OrderBy(cg => cg.Game.Name))
                            {
                                <div class="col">
                                    <div class="card h-100 border-0 shadow-sm text-center">
                                        <div class="p-2">
                                            @if (!string.IsNullOrEmpty(cafeGame.Game.ImageUrl))
                                            {
                                                <img src="@cafeGame.Game.ImageUrl" class="card-img-top rounded object-fit-contain" style="height: 100px;" alt="@cafeGame.Game.Name">
                                            }
                                            else
                                            {
                                                <div class="bg-secondary bg-opacity-10 rounded d-flex align-items-center justify-content-center" style="height: 100px;">
                                                    <i class="bi bi-dice-5 text-secondary display-6"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="card-body p-2 d-flex flex-column">
                                            <h6 class="card-title small fw-bold mb-1 text-truncate" title="@cafeGame.Game.Name">@cafeGame.Game.Name</h6>
                                            @if (cafeGame.Game.BGGId.HasValue)
                                            {
                                                <a href="https://boardgamegeek.com/boardgame/@cafeGame.Game.BGGId" target="_blank" class="mt-auto text-decoration-none extra-small-link">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>BGG
                                                </a>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Reviews -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Reviews</h4>
                    <span class="badge bg-secondary">Total: @Model.TotalReviews</span>
                </div>
                <div class="card-body">
                    @if (Model.Reviews != null && Model.Reviews.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var review in Model.Reviews.OrderByDescending(r => r.VisitDate).ThenByDescending(r => r.CreatedAt).Take(10))
                            {
                                <div class="list-group-item px-0 py-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <div>
                                            <h6 class="mb-0 fw-bold">
                                                 @(review.User?.GetFullName() ?? review.Title?.Replace("Google Maps Review - ", "") ?? "Anonymous")
                                            </h6>
                                            <small class="text-muted">@review.GetTimeAgo()</small>
                                        </div>
                                        <span class="badge bg-light text-warning border border-warning">
                                            @review.Rating <i class="bi bi-star-fill"></i>
                                        </span>
                                    </div>
                                    <p class="mb-0">@review.Content</p>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-4">No reviews yet.</p>
                    }
                </div>
            </div>

            <!-- Tips for Visitors -->
            <div class="card mb-4 border-0 bg-light">
                <div class="card-header bg-transparent border-0 pt-3">
                    <h4 class="mb-0"><i class="bi bi-lightbulb me-2 text-warning"></i>Tips for Visiting</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-calendar-check text-primary me-3 fs-4"></i>
                                <div>
                                    <h6 class="mb-1">Make a Reservation</h6>
                                    <p class="text-muted small mb-0">Board game cafes can get busy, especially on weekends. Call ahead to reserve a table.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-clock text-primary me-3 fs-4"></i>
                                <div>
                                    <h6 class="mb-1">Plan Your Time</h6>
                                    <p class="text-muted small mb-0">Most games take 1-3 hours. Allow extra time to browse the library and learn new games.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-people text-primary me-3 fs-4"></i>
                                <div>
                                    <h6 class="mb-1">Bring Friends</h6>
                                    <p class="text-muted small mb-0">Many games are best with 3-5 players. Gather your group for the best experience.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-question-circle text-primary me-3 fs-4"></i>
                                <div>
                                    <h6 class="mb-1">Ask for Recommendations</h6>
                                    <p class="text-muted small mb-0">Staff are usually board game enthusiasts who can suggest games based on your preferences.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Map & Hours -->
        <div class="col-lg-4">
            <!-- Quick Info Card -->
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Quick Info</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        @if (hasGames)
                        {
                            <li class="mb-3 d-flex align-items-center">
                                <i class="bi bi-controller text-primary me-3 fs-5"></i>
                                <div>
                                    <strong>@gameCount</strong> <span class="text-muted">Board Games</span>
                                </div>
                            </li>
                        }
                        @if (Model.AverageRating > 0)
                        {
                            <li class="mb-3 d-flex align-items-center">
                                <i class="bi bi-star-fill text-warning me-3 fs-5"></i>
                                <div>
                                    <strong>@Model.AverageRating.Value.ToString("0.0")</strong> <span class="text-muted">Rating (@reviewCount reviews)</span>
                                </div>
                            </li>
                        }
                        @if (!string.IsNullOrEmpty(Model.PriceRange))
                        {
                            <li class="mb-3 d-flex align-items-center">
                                <i class="bi bi-currency-dollar text-success me-3 fs-5"></i>
                                <div>
                                    <strong>@Model.PriceRange</strong> <span class="text-muted">Price Range</span>
                                </div>
                            </li>
                        }
                        <li class="d-flex align-items-center">
                            <i class="bi bi-geo-alt text-danger me-3 fs-5"></i>
                            <div>
                                <span class="text-muted">@Model.City, @Model.Country</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Map Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body p-0">
                    <div id="cafeMap" style="height: 300px; width: 100%; border-radius: 4px 4px 0 0;"></div>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.GoogleMapsUrl))
                    {
                        <a href="@Model.GoogleMapsUrl" target="_blank" class="btn btn-primary w-100">
                            <i class="bi bi-map-fill"></i> Open in Google Maps
                        </a>
                    }
                    else
                    {
                        <a href="https://www.google.com/maps/search/?api=1&query=@Model.Latitude,@Model.Longitude" target="_blank" class="btn btn-primary w-100">
                             <i class="bi bi-map-fill"></i> Open in Google Maps
                        </a>
                    }
                </div>
            </div>

            <!-- Opening Hours -->
            @if (!string.IsNullOrEmpty(Model.OpeningHours))
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-clock me-2"></i>Opening Hours</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text" style="white-space: pre-line;">@Model.OpeningHours.Replace(";", "\n")</p>
                    </div>
                </div>
            }

            <!-- Share This Cafe -->
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-share me-2"></i>Share This Cafe</h5>
                </div>
                <div class="card-body text-center">
                    <p class="text-muted small mb-3">Know someone who would love this place? Share it!</p>
                    <div class="d-flex justify-content-center gap-2">
                        <a href="https://www.facebook.com/sharer/sharer.php?u=@Uri.EscapeDataString($"{Context.Request.Scheme}://{Context.Request.Host}/Home/Details/{Model.CafeId}")"
                           target="_blank" class="btn btn-outline-primary btn-sm" title="Share on Facebook">
                            <i class="bi bi-facebook"></i>
                        </a>
                        <a href="https://twitter.com/intent/tweet?url=@Uri.EscapeDataString($"{Context.Request.Scheme}://{Context.Request.Host}/Home/Details/{Model.CafeId}")&text=@Uri.EscapeDataString($"Check out {Model.Name} - a board game cafe in {Model.City}!")"
                           target="_blank" class="btn btn-outline-dark btn-sm" title="Share on X">
                            <i class="bi bi-twitter-x"></i>
                        </a>
                        <a href="mailto:?subject=@Uri.EscapeDataString($"Check out {Model.Name}")&body=@Uri.EscapeDataString($"I found this great board game cafe: {Model.Name} in {Model.City}. Check it out: {Context.Request.Scheme}://{Context.Request.Host}/Home/Details/{Model.CafeId}")"
                           class="btn btn-outline-secondary btn-sm" title="Share via Email">
                            <i class="bi bi-envelope"></i>
                        </a>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="copyToClipboard()" title="Copy Link">
                            <i class="bi bi-link-45deg"></i>
                        </button>
                    </div>
                    <div id="copyAlert" class="alert alert-success py-1 px-2 mt-2 small d-none">Link copied!</div>
                </div>
            </div>

            <!-- Back to Browse -->
            <div class="d-grid gap-2 mb-4">
                <a href="/" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Browse Cafes
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        .extra-small-link {
            font-size: 0.7rem;
            color: #6c757d;
        }
        .extra-small-link:hover {
            color: #0d6efd;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var lat = @Model.Latitude;
            var lng = @Model.Longitude;
            var cafeName = "@Html.Raw(Model.Name.Replace("\"", "\\\""))";

            var map = L.map('cafeMap').setView([lat, lng], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([lat, lng]).addTo(map)
                .bindPopup('<b>' + cafeName + '</b>')
                .openPopup();
        });

        function copyToClipboard() {
            var url = window.location.href;
            navigator.clipboard.writeText(url).then(function() {
                var alert = document.getElementById('copyAlert');
                alert.classList.remove('d-none');
                setTimeout(function() {
                    alert.classList.add('d-none');
                }, 2000);
            });
        }
    </script>
}
