@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.Extensions.Localization
@using BoardGameCafeFinder
@inject IStringLocalizer<SharedResource> SharedLocalizer
@{
    ViewData["Title"] = SharedLocalizer["Pricing_Title"].Value;
    Layout = "_UserLayout";

    var plans = ViewBag.Plans as Dictionary<string, BoardGameCafeFinder.Controllers.ListingPlan>;
}

<!-- Hero Section -->
<div class="bg-gradient-primary text-white py-5">
    <div class="container text-center">
        <h1 class="display-5 fw-bold mb-3">
            <i class="bi bi-star-fill me-2"></i>@SharedLocalizer["Pricing_Title"]
        </h1>
        <p class="lead opacity-90 mb-0">
            @SharedLocalizer["Pricing_Subtitle"]
        </p>
    </div>
</div>

<div class="container py-5">
    <!-- Plans Section -->
    <div class="row justify-content-center mb-5">
        @if (plans != null)
        {
            @foreach (var plan in plans)
            {
                var isPremium = plan.Key == "Premium";
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 shadow @(isPremium ? "border-primary border-2" : "")">
                        @if (isPremium)
                        {
                            <div class="card-header bg-primary text-white text-center py-2">
                                <i class="bi bi-star-fill me-1"></i> @SharedLocalizer["Pricing_MostPopular"]
                            </div>
                        }
                        <div class="card-body text-center p-4">
                            <h3 class="card-title mb-3">@plan.Key</h3>
                            <div class="mb-4">
                                <span class="display-4 fw-bold text-primary">$@plan.Value.MonthlyPrice</span>
                                <span class="text-muted">@SharedLocalizer["Pricing_PerMonth"]</span>
                            </div>

                            <ul class="list-unstyled text-start mb-4">
                                @foreach (var featureKey in plan.Value.Features)
                                {
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        @SharedLocalizer[featureKey]
                                    </li>
                                }
                            </ul>
                        </div>
                        <div class="card-footer bg-white border-0 pb-4 text-center">
                            <button type="button" class="btn @(isPremium ? "btn-primary" : "btn-outline-primary") btn-lg w-100 select-plan-btn"
                                    data-plan="@plan.Key" data-bs-toggle="modal" data-bs-target="#selectCafeModal">
                                @SharedLocalizer["Pricing_GetStarted"]
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <!-- Features Comparison -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-white">
            <h4 class="mb-0"><i class="bi bi-table me-2"></i>@SharedLocalizer["Pricing_FeatureComparison"]</h4>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>@SharedLocalizer["Pricing_Feature"]</th>
                            <th class="text-center">Basic</th>
                            <th class="text-center bg-primary bg-opacity-10">Premium</th>
                            <th class="text-center">Featured</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>@SharedLocalizer["Pricing_BasicListing"]</td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_ContactInfo"]</td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_BusinessHours"]</td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_LocationOnMap"]</td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_PhotoGallery"]</td>
                            <td class="text-center"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-check-lg text-success fs-5"></i> @string.Format(SharedLocalizer["Pricing_UpTo"].Value, 10)</td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i> @SharedLocalizer["Pricing_Unlimited"]</td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_EventListings"]</td>
                            <td class="text-center"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_PrioritySearch"]</td>
                            <td class="text-center"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-check-lg text-success fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_FeaturedHomepage"]</td>
                            <td class="text-center"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_GameInventory"]</td>
                            <td class="text-center"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                        <tr>
                            <td>@SharedLocalizer["Pricing_Analytics"]</td>
                            <td class="text-center"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center bg-primary bg-opacity-10"><i class="bi bi-x-lg text-muted fs-5"></i></td>
                            <td class="text-center"><i class="bi bi-check-lg text-success fs-5"></i></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FAQ Section -->
    <div class="mb-5">
        <h3 class="text-center mb-4"><i class="bi bi-question-circle me-2"></i>@SharedLocalizer["Pricing_FAQ"]</h3>
        <div class="accordion" id="faqAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                        @SharedLocalizer["Pricing_FAQ1_Q"]
                    </button>
                </h2>
                <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        @SharedLocalizer["Pricing_FAQ1_A"]
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                        @SharedLocalizer["Pricing_FAQ2_Q"]
                    </button>
                </h2>
                <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        @SharedLocalizer["Pricing_FAQ2_A"]
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                        @SharedLocalizer["Pricing_FAQ3_Q"]
                    </button>
                </h2>
                <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        @SharedLocalizer["Pricing_FAQ3_A"]
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                        @SharedLocalizer["Pricing_FAQ4_Q"]
                    </button>
                </h2>
                <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        @SharedLocalizer["Pricing_FAQ4_A"]
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CTA Section -->
    <div class="text-center py-4 bg-light rounded">
        <h4>@SharedLocalizer["Pricing_ReadyToGrow"]</h4>
        <p class="text-muted mb-3">@SharedLocalizer["Pricing_JoinCafes"]</p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <a href="/" class="btn btn-primary btn-lg">
                <i class="bi bi-search me-2"></i>@SharedLocalizer["Pricing_FindYourCafe"]
            </a>
            <a href="/Listing/SubmitCafe" class="btn btn-outline-primary btn-lg">
                <i class="bi bi-plus-circle me-2"></i>@SharedLocalizer["Pricing_AddYourCafe"]
            </a>
        </div>
    </div>
</div>

<!-- Select Cafe Modal -->
<div class="modal fade" id="selectCafeModal" tabindex="-1" aria-labelledby="selectCafeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="selectCafeModalLabel">
                    <i class="bi bi-search me-2"></i>@SharedLocalizer["Pricing_FindYourCafe"]
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">@SharedLocalizer["Pricing_SearchCafe"] <strong id="selectedPlanName">Premium</strong>.</p>

                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="cafeSearchInput" placeholder="@SharedLocalizer["Pricing_SearchPlaceholder"]">
                    </div>
                </div>

                <div id="searchResults" class="mt-3" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted py-4" id="searchPlaceholder">
                        <i class="bi bi-shop display-4"></i>
                        <p class="mt-2" id="searchPlaceholderText">@SharedLocalizer["Pricing_StartTyping"]</p>
                    </div>
                    <div id="searchResultsList" class="list-group" style="display: none;"></div>
                    <div id="noResults" class="text-center text-muted py-4" style="display: none;">
                        <i class="bi bi-emoji-frown display-4"></i>
                        <p class="mt-2" id="noResultsText">@SharedLocalizer["Pricing_NoCafesFound"]</p>
                        <p class="small">@SharedLocalizer["Pricing_CantFindCafe"] <a href="/Listing/SubmitCafe" class="fw-bold">@SharedLocalizer["Pricing_AddItNow"]</a></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@SharedLocalizer["Common_Cancel"]</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="selectedPlan" value="Premium">

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .cafe-result-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .cafe-result-item:hover {
        background-color: #f8f9fa;
    }
</style>

@section Scripts {
<script>
    // Localized strings for JavaScript
    const localizedStrings = {
        loading: @Html.Raw(Json.Serialize(SharedLocalizer["Common_Loading"].Value)),
        searchError: @Html.Raw(Json.Serialize(SharedLocalizer["Pricing_SearchError"].Value)),
        startTyping: @Html.Raw(Json.Serialize(SharedLocalizer["Pricing_StartTyping"].Value))
    };

    let searchTimeout;
    const selectedPlanInput = document.getElementById('selectedPlan');
    const selectedPlanName = document.getElementById('selectedPlanName');
    const cafeSearchInput = document.getElementById('cafeSearchInput');
    const searchPlaceholder = document.getElementById('searchPlaceholder');
    const searchResultsList = document.getElementById('searchResultsList');
    const noResults = document.getElementById('noResults');

    // Handle plan selection
    document.querySelectorAll('.select-plan-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const plan = this.dataset.plan;
            selectedPlanInput.value = plan;
            selectedPlanName.textContent = plan;
            cafeSearchInput.value = '';
            searchPlaceholder.style.display = 'block';
            searchResultsList.style.display = 'none';
            noResults.style.display = 'none';
        });
    });

    // Handle cafe search
    cafeSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            searchPlaceholder.style.display = 'block';
            searchResultsList.style.display = 'none';
            noResults.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(() => searchCafes(query), 300);
    });

    async function searchCafes(query) {
        try {
            searchPlaceholder.innerHTML = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">${localizedStrings.loading}</span></div>`;

            const response = await fetch(`/api/cafes/search?q=${encodeURIComponent(query)}&limit=10`);
            const cafes = await response.json();

            searchPlaceholder.style.display = 'none';

            if (cafes.length === 0) {
                searchResultsList.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            searchResultsList.innerHTML = cafes.map(cafe => `
                <a href="/Listing/Claim/${cafe.cafeId}?plan=${selectedPlanInput.value}"
                   class="list-group-item list-group-item-action cafe-result-item">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${cafe.localImagePath
                                ? `<img src="${cafe.localImagePath}" alt="${cafe.name}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">`
                                : `<div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="bi bi-shop text-white"></i></div>`
                            }
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${cafe.name}</h6>
                            <small class="text-muted">
                                <i class="bi bi-geo-alt me-1"></i>${cafe.city}${cafe.country ? ', ' + cafe.country : ''}
                            </small>
                        </div>
                        <div>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </a>
            `).join('');
            searchResultsList.style.display = 'block';

        } catch (error) {
            console.error('Search error:', error);
            searchPlaceholder.innerHTML = `<p class="text-danger">${localizedStrings.searchError}</p>`;
            searchPlaceholder.style.display = 'block';
        }
    }

    // Reset search placeholder
    searchPlaceholder.innerHTML = `
        <i class="bi bi-shop display-4"></i>
        <p class="mt-2">${localizedStrings.startTyping}</p>
    `;
</script>
}
