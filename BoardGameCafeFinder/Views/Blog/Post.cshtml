@model BoardGameCafeFinder.Controllers.DynamicBlogPost
@{
    ViewData["Title"] = $"Board Game Cafes in {Model.City}, {Model.Country} - Complete Guide {DateTime.Now.Year}";
    ViewData["MetaDescription"] = $"Discover {Model.TotalCafes} board game cafes in {Model.City}, {Model.Country}. Find the best places to play board games with {Model.TotalGames}+ games available. Reviews, ratings & directions.";
    Layout = "_UserLayout";

    // Helper function to create URL-friendly slug from city name
    string ToSlug(string cityName) => cityName.ToLower().Replace(" ", "-");

    // SEO: Canonical URL
    ViewData["CanonicalUrl"] = $"{Context.Request.Scheme}://{Context.Request.Host}/blog/{ToSlug(Model.City)}";

    // SEO: Dynamic OG Image (first cafe image or default)
    var firstCafeImage = Model.Cafes.FirstOrDefault()?.LocalImagePath;
    if (!string.IsNullOrEmpty(firstCafeImage))
    {
        ViewData["OGImage"] = firstCafeImage;
    }

    // SEO: Keywords
    ViewData["Keywords"] = $"board game cafe {Model.City}, board game lounge {Model.City}, tabletop gaming {Model.City}, {Model.Country} board games, where to play board games {Model.City}";

    var relatedCities = ViewBag.RelatedCities as List<string> ?? new List<string>();
}

@section Head {
    <!-- JSON-LD Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "Article",
        "headline": "Board Game Cafes in @Model.City - Complete Guide",
        "description": "@ViewData["MetaDescription"]",
        "author": {
            "@@type": "Organization",
            "name": "Board Game Cafe Finder"
        },
        "publisher": {
            "@@type": "Organization",
            "name": "Board Game Cafe Finder",
            "logo": {
                "@@type": "ImageObject",
                "url": "@($"{Context.Request.Scheme}://{Context.Request.Host}/logo.svg")"
            }
        },
        "mainEntityOfPage": {
            "@@type": "WebPage",
            "@@id": "@ViewData["CanonicalUrl"]"
        },
        "about": {
            "@@type": "ItemList",
            "name": "Board Game Cafes in @Model.City",
            "numberOfItems": @Model.TotalCafes,
            "itemListElement": [
                @for (int i = 0; i < Math.Min(Model.Cafes.Count, 10); i++)
                {
                    var cafe = Model.Cafes[i];
                    <text>
                {
                    "@@type": "ListItem",
                    "position": @(i + 1),
                    "item": {
                        "@@type": "LocalBusiness",
                        "name": "@cafe.Name.Replace("\"", "\\\"")",
                        "address": {
                            "@@type": "PostalAddress",
                            "addressLocality": "@Model.City",
                            "addressCountry": "@Model.Country"
                        }@if (cafe.AverageRating.HasValue && cafe.TotalReviews > 0)
                        {<text>,
                        "aggregateRating": {
                            "@@type": "AggregateRating",
                            "ratingValue": "@cafe.AverageRating.Value.ToString("F1")",
                            "bestRating": "5",
                            "ratingCount": "@cafe.TotalReviews"
                        }</text>}
                    }
                }@(i < Math.Min(Model.Cafes.Count, 10) - 1 ? "," : "")
                    </text>
                }
            ]
        }
    }
    </script>
}

<!-- Hero Section -->
<div class="bg-gradient-primary text-white py-5">
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/Blog" class="text-white-50">Guides</a></li>
                <li class="breadcrumb-item"><a href="/Blog?country=@Uri.EscapeDataString(Model.Country)" class="text-white-50">@Model.Country</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">@Model.City</li>
            </ol>
        </nav>
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="display-5 fw-bold mb-3">
                    Board Game Cafes in @Model.City
                </h1>
                <p class="lead opacity-90">
                    Your complete guide to @Model.TotalCafes board game @(Model.TotalCafes == 1 ? "cafe" : "cafes") in @Model.City, @Model.Country
                </p>
                <div class="d-flex flex-wrap gap-3 mt-4">
                    <div class="bg-white bg-opacity-25 rounded px-3 py-2">
                        <i class="bi bi-shop me-1"></i>
                        <strong>@Model.TotalCafes</strong> Cafes
                    </div>
                    <div class="bg-white bg-opacity-25 rounded px-3 py-2">
                        <i class="bi bi-controller me-1"></i>
                        <strong>@Model.TotalGames</strong> Games
                    </div>
                    @if (Model.AverageRating > 0)
                    {
                        <div class="bg-white bg-opacity-25 rounded px-3 py-2">
                            <i class="bi bi-star-fill me-1"></i>
                            <strong>@Model.AverageRating.ToString("F1")</strong> Avg Rating
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Introduction -->
            <div class="mb-5">
                <h2 class="h4 mb-3"><i class="bi bi-info-circle me-2"></i>About Board Game Cafes in @Model.City</h2>
                <p class="lead">
                    @Model.City is home to <strong>@Model.TotalCafes board game @(Model.TotalCafes == 1 ? "cafe" : "cafes")</strong>,
                    offering a combined library of over <strong>@Model.TotalGames games</strong> for visitors to enjoy.
                    Whether you're looking for a casual game night spot or a dedicated gaming venue, you'll find great options here.
                </p>
            </div>

            <!-- Top Games Section -->
            @if (Model.TopGames.Any())
            {
                <div class="mb-5">
                    <h2 class="h4 mb-4"><i class="bi bi-trophy me-2"></i>Most Popular Games in @Model.City</h2>
                    <p class="text-muted mb-4">These games appear most frequently across cafes in @Model.City:</p>

                    <div class="row">
                        @foreach (var item in Model.TopGames.Take(6))
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 shadow-sm">
                                    <div class="row g-0">
                                        <div class="col-4">
                                            @if (!string.IsNullOrEmpty(item.Game.ImageUrl))
                                            {
                                                <img src="@item.Game.ImageUrl" class="img-fluid rounded-start h-100" alt="@item.Game.Name"
                                                     loading="lazy" decoding="async" style="object-fit: cover;">
                                            }
                                            else
                                            {
                                                <div class="bg-secondary h-100 d-flex align-items-center justify-content-center rounded-start">
                                                    <i class="bi bi-dice-5 text-white display-6"></i>
                                                </div>
                                            }
                                        </div>
                                        <div class="col-8">
                                            <div class="card-body py-2">
                                                <h6 class="card-title mb-1">@item.Game.Name</h6>
                                                <div class="small text-muted mb-2">
                                                    @if (item.Game.MinPlayers.HasValue && item.Game.MaxPlayers.HasValue)
                                                    {
                                                        <span class="me-2"><i class="bi bi-people"></i> @item.Game.MinPlayers-@item.Game.MaxPlayers</span>
                                                    }
                                                    @if (item.Game.PlaytimeMinutes.HasValue)
                                                    {
                                                        <span><i class="bi bi-clock"></i> @item.Game.PlaytimeMinutes min</span>
                                                    }
                                                </div>
                                                <span class="badge bg-success">
                                                    <i class="bi bi-shop"></i> At @item.CafeCount @(item.CafeCount == 1 ? "cafe" : "cafes")
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Cafes List -->
            <div class="mb-5">
                <h2 class="h4 mb-4"><i class="bi bi-geo-alt me-2"></i>All Board Game Cafes in @Model.City</h2>

                @foreach (var cafe in Model.Cafes)
                {
                    <div class="card mb-4 shadow-sm cafe-card">
                        <div class="row g-0">
                            <div class="col-md-4">
                                @{
                                    var photo = cafe.Photos?.OrderBy(p => p.DisplayOrder).FirstOrDefault();
                                    var imageUrl = photo?.LocalPath ?? photo?.Url ?? cafe.LocalImagePath;
                                }
                                @if (!string.IsNullOrEmpty(imageUrl))
                                {
                                    <a href="/cafe/@cafe.Slug">
                                        <img src="@imageUrl" class="img-fluid rounded-start h-100" alt="@cafe.Name"
                                             loading="lazy" decoding="async" style="object-fit: cover; min-height: 200px;">
                                    </a>
                                }
                                else
                                {
                                    <div class="bg-gradient-primary h-100 d-flex align-items-center justify-content-center rounded-start" style="min-height: 200px;">
                                        <i class="bi bi-shop text-white display-4 opacity-50"></i>
                                    </div>
                                }
                            </div>
                            <div class="col-md-8">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h5 class="card-title mb-1">
                                            <a href="/cafe/@cafe.Slug" class="text-decoration-none">@cafe.Name</a>
                                        </h5>
                                        @if (cafe.AverageRating.HasValue)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-star-fill"></i> @cafe.AverageRating.Value.ToString("F1")
                                            </span>
                                        }
                                    </div>

                                    <p class="text-muted small mb-2">
                                        <i class="bi bi-geo-alt"></i> @cafe.Address
                                    </p>

                                    @if (!string.IsNullOrEmpty(cafe.Description))
                                    {
                                        <p class="card-text">
                                            @(cafe.Description.Length > 150 ? cafe.Description.Substring(0, 147) + "..." : cafe.Description)
                                        </p>
                                    }

                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        @{
                                            var gameCount = cafe.CafeGames?.Count ?? 0;
                                        }
                                        @if (gameCount > 0)
                                        {
                                            <span class="badge bg-success">
                                                <i class="bi bi-controller"></i> @gameCount games
                                            </span>
                                        }
                                        @if (cafe.IsVerified)
                                        {
                                            <span class="badge bg-primary">
                                                <i class="bi bi-check-circle"></i> Verified
                                            </span>
                                        }
                                        @if (!string.IsNullOrEmpty(cafe.PriceRange))
                                        {
                                            <span class="badge bg-info">@cafe.PriceRange</span>
                                        }
                                    </div>

                                    <div class="d-flex gap-2">
                                        <a href="/cafe/@cafe.Slug" class="btn btn-primary btn-sm">
                                            <i class="bi bi-info-circle"></i> View Details
                                        </a>
                                        @if (!string.IsNullOrEmpty(cafe.Website))
                                        {
                                            <a href="@cafe.Website" target="_blank" class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-globe"></i> Website
                                            </a>
                                        }
                                        @if (!string.IsNullOrEmpty(cafe.GoogleMapsUrl))
                                        {
                                            <a href="@cafe.GoogleMapsUrl" target="_blank" class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-map"></i> Directions
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Tips Section -->
            <div class="card bg-light border-0 mb-5">
                <div class="card-body">
                    <h3 class="h5 mb-3"><i class="bi bi-lightbulb me-2"></i>Tips for Visiting Board Game Cafes</h3>
                    <ul class="mb-0">
                        <li><strong>Make a reservation:</strong> Popular cafes can fill up quickly, especially on weekends.</li>
                        <li><strong>Ask for recommendations:</strong> Staff are usually gamers themselves and can suggest the perfect game for your group.</li>
                        <li><strong>Plan your time:</strong> Most games take 1-3 hours. Give yourself plenty of time to enjoy.</li>
                        <li><strong>Try something new:</strong> Step outside your comfort zone and try a game you've never played before!</li>
                    </ul>
                </div>
            </div>

            <!-- CTA -->
            <div class="text-center py-4">
                <h4>Ready to Play?</h4>
                <p class="text-muted">Find all board game cafes in @Model.City on our map</p>
                <a href="/?city=@Uri.EscapeDataString(Model.City)" class="btn btn-primary btn-lg">
                    <i class="bi bi-search me-2"></i>Browse Cafes in @Model.City
                </a>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Facts -->
            <div class="card shadow-sm mb-4 sticky-top" style="top: 1rem;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Quick Facts</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted">Total Cafes</span>
                            <strong>@Model.TotalCafes</strong>
                        </li>
                        <li class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted">Total Games</span>
                            <strong>@Model.TotalGames</strong>
                        </li>
                        <li class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted">Average Rating</span>
                            <strong>
                                @if (Model.AverageRating > 0)
                                {
                                    <span><i class="bi bi-star-fill text-warning"></i> @Model.AverageRating.ToString("F1")</span>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </strong>
                        </li>
                        <li class="d-flex justify-content-between py-2">
                            <span class="text-muted">Country</span>
                            <strong>@Model.Country</strong>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Related Cities -->
            @if (relatedCities.Any())
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>More Cities in @Model.Country</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var city in relatedCities)
                            {
                                <a href="/blog/@ToSlug(city)" class="btn btn-sm btn-outline-primary">
                                    @city
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Map Link -->
            <div class="card shadow-sm bg-gradient-primary text-white">
                <div class="card-body text-center py-4">
                    <i class="bi bi-map display-4 mb-3"></i>
                    <h5>View on Map</h5>
                    <p class="small opacity-90">See all cafes in @Model.City on our interactive map.</p>
                    <a href="/Map?city=@Uri.EscapeDataString(Model.City)" class="btn btn-light">
                        <i class="bi bi-map me-1"></i> Open Map
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .cafe-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .cafe-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        color: rgba(255, 255, 255, 0.5);
    }
</style>
